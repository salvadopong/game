<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üèÜ PONG CHAMPIONSHIP 2.9 üèÜ</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --paddle-width: 15px;
      --ball-radius: 6px;
      --paddle-speed: 10;
      --initial-ball-speed: 7;
      --max-ball-speed: 11;
      --four-player-ball-speed: 8;
    }
    
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #1a26c3, #b21b41, #fdbb1d);
      font-family: 'Arial', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 100vh;
      width: 100vw;
    }
    
    #gameContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    canvas {
      background: linear-gradient(135deg, #1a26c3, #b21b41, #fdbb1d);
      display: block;
      touch-action: none;
      width: 100%;
      height: 100%;
      border-radius: 0;
    }
    
    .score {
      position: absolute;
      top: 20px;
      font-size: 3rem;
      color: white;
      text-shadow: 0 0 10px rgba(255,255,255,0.7);
      z-index: 30;
      font-weight: bold;
      font-family: 'Impact', sans-serif;
      display: none;
    }
    
    #leftScore { left: 25%; }
    #rightScore { right: 25%; }
    
    #timer {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      color: gold;
      z-index: 30;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255,215,0,0.7);
      display: none;
    }
    
    #bonusPoints {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: gold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      font-weight: bold;
      display: none;
    }
    
    #matchInfo {
      position: absolute;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      display: none;
    }
    
    #commentary {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      max-width: 90%;
      text-align: center;
      font-size: 1.1rem;
      z-index: 30;
      font-weight: bold;
      border: 2px solid gold;
      box-shadow: 0 0 10px rgba(255,215,0,0.5);
      transition: all 0.3s;
      font-family: 'Arial Black', sans-serif;
    }
    
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .screen h1 {
      font-size: 3rem;
      color: gold;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      margin-bottom: 1rem;
      text-align: center;
      font-family: 'Impact', sans-serif;
      letter-spacing: 2px;
    }
    
    .btn-championship {
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      border: none;
      font-size: 1.5rem;
      padding: 12px 30px;
      margin: 10px;
      border-radius: 50px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.2s;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Arial Black', sans-serif;
    }
    
    .btn-championship:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    
    .control-btn {
      position: absolute;
      z-index: 40;
      background: rgba(255,255,255,0.3);
      border: 2px solid white;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
      box-shadow: 0 0 8px rgba(255,255,255,0.4);
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.4);
    }
    
    #muteButton { top: 15px; left: 15px; }
    #pauseButton { top: 15px; left: 70px; }
    #fullscreenButton { top: 15px; left: 125px; }
    #musicMuteButton { top: 15px; right: 15px; }
    #backButton { top: 15px; right: 70px; }
    #whatsNewButton { 
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(255,255,255,0.3);
      border: 2px solid white;
      border-radius: 20px;
      padding: 5px 15px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      z-index: 40;
    }
    
    #pauseScreen, #countdown, #halftimeScreen, #gameOverScreen {
      display: none;
    }
    
    #mobileControls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
    }
    
    .mobile-paddle-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .mobile-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      border: 2px solid white;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.8rem;
      user-select: none;
      touch-action: manipulation;
      box-shadow: 0 0 10px rgba(255,255,255,0.4);
    }
    
    .mobile-btn:active {
      background: rgba(255,255,255,0.5);
    }
    
    .mobile-power-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,215,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      color: gold;
      font-size: 1.5rem;
      user-select: none;
      touch-action: manipulation;
      border: 2px solid gold;
      box-shadow: 0 0 10px rgba(255,215,0,0.5);
      position: absolute;
      bottom: 100px;
    }
    
    .mobile-power-btn:active {
      background: rgba(255,215,0,0.5);
    }
    
    #leftPowerBtn {
      left: 20%;
    }
    
    #rightPowerBtn {
      right: 20%;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 90%;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
      border: 3px solid gold;
    }
    
    .modal-title {
      color: gold;
      font-size: 2rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      font-family: 'Impact', sans-serif;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 15px;
      border: 2px solid gold;
      font-size: 1.3rem;
      text-align: center;
      background: rgba(0,0,0,0.7);
      color: white;
      font-family: 'Arial', sans-serif;
    }
    
    .modal-btn {
      padding: 12px 30px;
      margin: 0 10px;
      border-radius: 50px;
      border: none;
      background: gold;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1rem;
      font-family: 'Arial Black', sans-serif;
    }
    
    .modal-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,215,0,0.7);
    }
    
    #countdown {
      font-size: 8rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.7);
      animation: pulse 0.5s infinite alternate;
    }
    
    #halftimeScreen {
      font-size: 4rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.7);
    }
    
    #gameOverScreen {
      font-size: 4rem;
      font-weight: bold;
      color: red;
      text-shadow: 0 0 20px rgba(255,0,0,0.7);
    }
    
    @keyframes pulse {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(1.2); opacity: 0.8; }
    }
    
    #goText {
      font-size: 8rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.7);
      animation: goPulse 0.3s infinite alternate, fadeOut 1s 1s forwards;
      display: none;
    }
    
    @keyframes goPulse {
      from { transform: scale(1); text-shadow: 0 0 20px rgba(255,215,0,0.7); }
      to { transform: scale(1.3); text-shadow: 0 0 40px rgba(255,215,0,0.9); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    
    /* Power shot effects - Updated with separate bars */
    .paddle-charge-container {
      position: absolute;
      bottom: 10px;
      width: 100px;
      height: 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      overflow: hidden;
      z-index: 20;
    }
    
    .paddle-charge {
      position: absolute;
      height: 100%;
      background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
      border-radius: 8px;
      transition: width 0.1s;
    }
    
    #leftChargeContainer {
      left: 20px;
    }
    
    #rightChargeContainer {
      right: 20px;
    }
    
    #leftCharge {
      left: 0;
      width: 0;
    }
    
    #rightCharge {
      right: 0;
      width: 0;
    }
    
    .paddle-charge-label {
      position: absolute;
      bottom: 30px;
      font-size: 0.8rem;
      color: white;
      text-shadow: 0 0 3px black;
      z-index: 20;
    }
    
    #leftChargeLabel {
      left: 20px;
    }
    
    #rightChargeLabel {
      right: 20px;
    }
    
    .paddle-charge.active {
      animation: chargePulse 0.5s infinite alternate;
    }
    
    @keyframes chargePulse {
      from { box-shadow: 0 0 3px gold; }
      to { box-shadow: 0 0 10px gold; }
    }
    
    /* Leaderboard Styles */
    #leaderboardScreen {
      display: none;
    }
    
    .leaderboard-tabs {
      display: flex;
      margin-bottom: 10px;
      width: 100%;
      justify-content: center;
    }
    
    .leaderboard-tab {
      padding: 8px 16px;
      background: rgba(255,215,0,0.2);
      border: 1px solid gold;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .leaderboard-tab:first-child {
      border-radius: 20px 0 0 20px;
    }
    
    .leaderboard-tab:last-child {
      border-radius: 0 20px 20px 0;
    }
    
    .leaderboard-tab.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    .leaderboard {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid gold;
      border-radius: 10px;
      padding: 12px;
      color: white;
      width: 100%;
      height: 60vh;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      font-family: 'Arial', sans-serif;
      display: none;
    }
    
    .leaderboard.active {
      display: block;
    }
    
    .leaderboard h3 {
      color: gold;
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
      font-size: 1.1rem;
      border-bottom: 1px solid gold;
      padding-bottom: 5px;
    }
    
    .leaderboard-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
    }
    
    .leaderboard-item:last-child {
      border-bottom: none;
    }
    
    .leaderboard-rank {
      color: gold;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .leaderboard-time {
      color: #aaa;
      font-size: 0.8rem;
      margin-top: 3px;
    }
    
    /* Difficulty selector */
    .difficulty-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .difficulty-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid gold;
      background: rgba(255,215,0,0.1);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .difficulty-btn:hover {
      background: rgba(255,215,0,0.2);
    }
    
    .difficulty-btn.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    /* Tournament stage selector */
    .stage-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 8px;
    }
    
    .stage-btn {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid gold;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .stage-btn:hover {
      background: rgba(255, 215, 0, 0.3);
    }
    
    .stage-btn.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    /* Intro animation */
    #introAnimation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #introText {
      font-size: 4rem;
      color: gold;
      text-shadow: 0 0 15px rgba(255,215,0,0.7);
      font-family: 'Impact', sans-serif;
      animation: textGlow 2s infinite alternate;
      margin-bottom: 1.5rem;
      text-align: center;
      transform: scale(0);
      opacity: 0;
    }
    
    @keyframes textGlow {
      from { text-shadow: 0 0 8px gold; }
      to { text-shadow: 0 0 20px gold, 0 0 30px gold; }
    }
    
    @keyframes textEntry {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #startButton {
      padding: 12px 25px;
      font-size: 1.3rem;
      border-radius: 50px;
      border: none;
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      transform: scale(0);
      opacity: 0;
    }
    
    #startButton:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,255,255,0.4);
    }
    
    /* Back button */
    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      color: white;
      font-size: 1.2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 110;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Practice mode instructions */
    #practiceInstructions {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 50;
      max-width: 80%;
      border: 2px solid gold;
      display: none;
    }
    
    /* Glow effect for UI elements */
    .glow {
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from {
        box-shadow: 0 0 5px rgba(255,215,0,0.5);
      }
      to {
        box-shadow: 0 0 20px rgba(255,215,0,0.8);
      }
    }
    
    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      margin: 0 10px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: gold;
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* D-Pad controls */
    #dpadControls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: none;
      z-index: 25;
    }
    
    #dpadControlsRight {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: none;
      z-index: 25;
    }
    
    .dpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 5px;
    }
    
    .dpad-btn {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.3);
      border: 2px solid white;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5rem;
      user-select: none;
      touch-action: manipulation;
    }
    
    .dpad-btn:active {
      background: rgba(255,255,255,0.5);
    }
    
    .dpad-up {
      grid-column: 2;
      grid-row: 1;
    }
    
    .dpad-down {
      grid-column: 2;
      grid-row: 3;
    }
    
    .dpad-power {
      grid-column: 3;
      grid-row: 2;
      background: rgba(255,215,0,0.3);
      border-color: gold;
      color: gold;
    }
    
    /* Whats New modal */
    #whatsNewModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 400;
    }
    
    #whatsNewContent {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 30px;
      border-radius: 20px;
      max-width: 90%;
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
      border: 3px solid gold;
    }
    
    #whatsNewContent h2 {
      color: gold;
      text-align: center;
      margin-bottom: 20px;
    }
    
    #whatsNewContent ul {
      text-align: left;
      color: white;
      font-size: 1.1rem;
      line-height: 1.6;
    }
    
    #whatsNewContent li {
      margin-bottom: 10px;
    }
    
    /* Confetti */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
    }
    
    /* Fire trail elements */
    .fire-trail {
      position: absolute;
      width: 5px;
      height: 5px;
      background-color: orange;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      opacity: 0.7;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .score { 
        font-size: 2.5rem; 
        top: 15px; 
      }
      #leftScore { left: 20%; }
      #rightScore { right: 20%; }
      #timer { font-size: 1.5rem; top: 15px; }
      #bonusPoints { font-size: 1rem; top: 50px; }
      #matchInfo { font-size: 0.9rem; top: 80px; }
      #commentary { 
        font-size: 1rem; 
        padding: 8px 15px; 
        bottom: 15px; 
        max-width: 95%;
      }
      .btn-championship { 
        font-size: 1.2rem; 
        padding: 10px 20px; 
        margin: 8px;
      }
      .control-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
      #muteButton { left: 10px; top: 10px; }
      #pauseButton { left: 60px; top: 10px; }
      #fullscreenButton { left: 110px; top: 10px; }
      #musicMuteButton { right: 10px; top: 10px; }
      #backButton { right: 60px; top: 10px; }
      #whatsNewButton { 
        bottom: 10px;
        right: 10px;
        font-size: 0.9rem;
        padding: 4px 12px;
      }
      .mobile-btn {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
      .mobile-power-btn {
        width: 60px;
        height: 60px;
        font-size: 1.3rem;
        bottom: 90px;
      }
      .modal-content {
        width: 90%;
        padding: 20px;
      }
      .modal-title {
        font-size: 1.6rem;
      }
      .modal-input {
        font-size: 1.1rem;
        padding: 10px;
      }
      #countdown, #goText {
        font-size: 5rem;
      }
      #halftimeScreen, #gameOverScreen {
        font-size: 3rem;
      }
      #introText {
        font-size: 2.5rem;
      }
      
      /* Adjust leaderboards for mobile */
      .leaderboard {
        width: 90%;
        max-width: none;
        font-size: 0.8rem;
      }
      
      /* Adjust power bars for mobile */
      .paddle-charge-container {
        width: 80px;
        height: 12px;
      }
      
      .paddle-charge-label {
        font-size: 0.7rem;
        bottom: 25px;
      }
      
      /* Adjust D-Pad for mobile */
      .dpad-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
    }
    
    @media (max-height: 500px) {
      .screen h1 { font-size: 2rem; }
      .btn-championship { 
        font-size: 1rem; 
        padding: 8px 15px;
        margin: 6px;
      }
      #mobileControls { bottom: 10px; }
      .mobile-btn { 
        width: 50px; 
        height: 50px; 
        font-size: 1.3rem;
      }
      .mobile-power-btn {
        width: 50px;
        height: 50px;
        font-size: 1.1rem;
        bottom: 70px;
      }
      #commentary { 
        bottom: 8px;
        font-size: 0.8rem;
      }
      #countdown, #goText {
        font-size: 3rem;
      }
      #halftimeScreen, #gameOverScreen {
        font-size: 2rem;
      }
      #introText {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Intro Animation Screen -->
  <div id="introAnimation">
    <div id="introText">PONG CHAMPIONSHIP 2.9</div>
    <button id="startButton">START</button>
  </div>

  <div id="gameContainer">
    <canvas id="pongCanvas"></canvas>
    
    <!-- Game elements (hidden during menu) -->
    <div id="leftScore" class="score">0</div>
    <div id="rightScore" class="score">0</div>
    <div id="timer">1:30.000</div>
    <div id="bonusPoints"></div>
    <div id="matchInfo"></div>
    <div id="commentary">WELCOME TO THE PONG CHAMPIONSHIP 2.9!</div>
    
    <!-- Power charge bars - now properly separated -->
    <div id="leftChargeContainer" class="paddle-charge-container">
      <div id="leftCharge" class="paddle-charge"></div>
    </div>
    <div id="leftChargeLabel" class="paddle-charge-label">P1 POWER</div>
    
    <div id="rightChargeContainer" class="paddle-charge-container">
      <div id="rightCharge" class="paddle-charge"></div>
    </div>
    <div id="rightChargeLabel" class="paddle-charge-label">P2 POWER</div>
    
    <button id="muteButton" class="control-btn">üîä</button>
    <button id="pauseButton" class="control-btn">‚è∏Ô∏è</button>
    <button id="fullscreenButton" class="control-btn">‚õ∂</button>
    <button id="musicMuteButton" class="control-btn">üéµ</button>
    <button id="backButton" class="control-btn" style="display: none;">‚Ü©Ô∏è</button>
    <button id="whatsNewButton" style="display: none;">‚ÑπÔ∏è What's New in 2.9</button>
    
    <div id="mobileControls" style="display: none;">
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnLeft">‚Üë</div>
        <div class="mobile-btn" id="downBtnLeft">‚Üì</div>
      </div>
      <div class="mobile-power-btn" id="leftPowerBtn">üí•</div>
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnRight">‚Üë</div>
        <div class="mobile-btn" id="downBtnRight">‚Üì</div>
      </div>
      <div class="mobile-power-btn" id="rightPowerBtn">üí•</div>
    </div>

    <!-- D-Pad controls -->
    <div id="dpadControls">
      <div class="dpad">
        <div class="dpad-btn dpad-up" id="dpadUpLeft">‚Üë</div>
        <div class="dpad-btn dpad-down" id="dpadDownLeft">‚Üì</div>
        <div class="dpad-btn dpad-power" id="dpadPowerLeft">üí•</div>
      </div>
    </div>

    <div id="dpadControlsRight">
      <div class="dpad">
        <div class="dpad-btn dpad-up" id="dpadUpRight">‚Üë</div>
        <div class="dpad-btn dpad-down" id="dpadDownRight">‚Üì</div>
        <div class="dpad-btn dpad-power" id="dpadPowerRight">üí•</div>
      </div>
    </div>

    <div id="countdown" class="screen"></div>
    <div id="goText" class="screen">GO!</div>
    <div id="halftimeScreen" class="screen"></div>
    <div id="gameOverScreen" class="screen">GAME OVER</div>

    <div id="pauseScreen" class="screen">
      <h1>GAME CURRENTLY PAUSED</h1>
      <button class="btn-championship" id="resumeButton">RESUME</button>
      <button class="btn-championship" id="returnToMenuButton">RETURN TO MENU</button>
    </div>

    <div id="titleScreen" class="screen">
      <h1>üèÜ PONG CHAMPIONSHIP 2.9 üèÜ</h1>
      <button class="btn-championship" id="twoPlayerButton">2 PLAYERS</button>
      <button class="btn-championship" id="singlePlayerButton">1 PLAYER VS BOT</button>
      <button class="btn-championship" id="fourPlayerButton">4 PLAYERS</button>
      <button class="btn-championship" id="leaderboardButton" style="margin-top: 20px;">LEADERBOARDS</button>
      <button class="btn-championship" id="practiceButton">PRACTICE</button>
      <button class="btn-championship" id="endlessButton">ENDLESS MODE</button>
      <button class="btn-championship" id="tutorialButton">TUTORIAL</button>
    </div>

    <div id="leaderboardScreen" class="screen">
      <h1>üèÜ LEADERBOARDS üèÜ</h1>
      <div class="leaderboard-tabs">
        <div class="leaderboard-tab active" data-tab="recent">RECENT PLAYS</div>
        <div class="leaderboard-tab" data-tab="best">BEST WINS</div>
        <div class="leaderboard-tab" data-tab="bot">BOT CHAMPIONS</div>
      </div>
      
      <div id="recentPlays" class="leaderboard active">
        <h3>RECENT PLAYS</h3>
        <div id="recentPlaysList"></div>
      </div>
      
      <div id="bestWins" class="leaderboard">
        <h3>BEST WINS</h3>
        <div id="bestWinsList"></div>
      </div>
      
      <div id="botChampion" class="leaderboard">
        <h3>BOT CHAMPIONS</h3>
        <div id="botChampionList"></div>
      </div>
      
      <button class="btn-championship" id="backToMenuButton" style="margin-top: 20px;">BACK TO MENU</button>
    </div>

    <div id="endScreen" class="screen" style="display: none;">
      <h1 id="endMessage" style="color: gold; font-size: 2rem;"></h1>
      <button class="btn-championship" id="endScreenBtn">RETURN TO MENU</button>
    </div>
  </div>

  <!-- Practice mode instructions -->
  <div id="practiceInstructions">
    <h3 id="practiceTitle"></h3>
    <p id="practiceText"></p>
    <button class="modal-btn" id="practiceContinue">CONTINUE</button>
  </div>

  <!-- Whats New Modal -->
  <div id="whatsNewModal">
    <div id="whatsNewContent">
      <h2>What's New in Pong Championship 2.9</h2>
      <ul>
        <li><strong>IMPROVED COUNTDOWN:</strong> Ball only released after "GO!" appears</li>
        <li><strong>FIXED POWER SHOT:</strong> Power shots now properly increase ball speed</li>
        <li><strong>ENHANCED COMMENTARY:</strong> Commentary stops after game ends and interrupts previous speech</li>
        <li><strong>PRACTICE MODE FIX:</strong> Right paddle is now AI-controlled in practice mode</li>
        <li><strong>MILLISECONDS TIMER:</strong> Timer now shows milliseconds counting down</li>
        <li><strong>HALFTIME FIX:</strong> Game fully pauses during halftime with proper commentary</li>
        <li><strong>END GAME FIX:</strong> Game completely stops after match ends</li>
        <li><strong>TOURNAMENT COMMENTARY:</strong> Special commentary for tournament finals</li>
      </ul>
      <button class="modal-btn" id="closeWhatsNew">CLOSE</button>
    </div>
  </div>

  <div id="twoPlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER PLAYER NAMES</div>
      <label>
        <input type="text" id="leftPlayerName" class="modal-input" placeholder="Left Player Name" maxlength="20">
      </label>
      <label>
        <input type="text" id="rightPlayerName" class="modal-input" placeholder="Right Player Name" maxlength="20">
      </label>
      
      <div class="stage-selector">
        <div class="stage-btn" data-stage="Round of 16">Round of 16</div>
        <div class="stage-btn" data-stage="Quarter Finals">Quarter Finals</div>
        <div class="stage-btn" data-stage="Semi Finals">Semi Finals</div>
        <div class="stage-btn" data-stage="Finals">Finals</div>
      </div>
      
      <input type="hidden" id="selectedStage" value="Round of 16">
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitTwoPlayerNames">START GAME</button>
        <button class="modal-btn" id="cancelTwoPlayer">BACK</button>
      </div>
    </div>
  </div>

  <div id="fourPlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER TEAM NAMES</div>
      <label>
        <input type="text" id="leftTeamName" class="modal-input" placeholder="Left Team Name" maxlength="20">
      </label>
      <label>
        <input type="text" id="rightTeamName" class="modal-input" placeholder="Right Team Name" maxlength="20">
      </label>
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitFourPlayerNames">START GAME</button>
        <button class="modal-btn" id="cancelFourPlayer">BACK</button>
      </div>
    </div>
  </div>

  <div id="singlePlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">WHAT IS YOUR NAME?</div>
      <label>
        <input type="text" id="playerName" class="modal-input" placeholder="Your Name" maxlength="20">
      </label>
      
      <div class="difficulty-selector">
        <div class="difficulty-btn active" data-difficulty="easy">EASY</div>
        <div class="difficulty-btn" data-difficulty="medium">MEDIUM</div>
        <div class="difficulty-btn" data-difficulty="hard">HARD</div>
      </div>
      <input type="hidden" id="selectedDifficulty" value="easy">
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitSinglePlayerName">START GAME</button>
        <button class="modal-btn" id="cancelSinglePlayer">BACK</button>
      </div>
    </div>
  </div>

  <div id="endlessPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENDLESS MODE</div>
      <label>
        <input type="text" id="endlessPlayerName" class="modal-input" placeholder="Your Name" maxlength="20">
      </label>
      
      <div class="difficulty-selector">
        <div class="difficulty-btn active" data-difficulty="easy">EASY</div>
        <div class="difficulty-btn" data-difficulty="medium">MEDIUM</div>
        <div class="difficulty-btn" data-difficulty="hard">HARD</div>
      </div>
      <input type="hidden" id="endlessDifficulty" value="easy">
      
      <div style="margin: 15px 0; display: flex; align-items: center; justify-content: center;">
        <label style="color: white; margin-right: 10px;">Show Score:</label>
        <label class="switch">
          <input type="checkbox" id="showScoreToggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="margin: 15px 0; display: flex; align-items: center; justify-content: center;">
        <label style="color: white; margin-right: 10px;">Commentary:</label>
        <label class="switch">
          <input type="checkbox" id="commentaryToggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="margin: 15px 0; display: flex; align-items: center; justify-content: center;">
        <label style="color: white; margin-right: 10px;">Opponent:</label>
        <label class="switch">
          <input type="checkbox" id="opponentToggle">
          <span class="slider"></span>
        </label>
        <span style="margin-left: 10px; color: white;">Bot/2P</span>
      </div>
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitEndlessName">START</button>
        <button class="modal-btn" id="cancelEndless">BACK</button>
      </div>
    </div>
  </div>

  <div id="practiceModePrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">PRACTICE MODE</div>
      <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
        <button class="modal-btn" id="learnPowerShotBtn">LEARN POWER SHOT</button>
        <button class="modal-btn" id="learnRespondingBtn">LEARN RESPONDING</button>
      </div>
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="cancelPractice">BACK</button>
      </div>
    </div>
  </div>

  <div id="tutorialModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">PONG CHAMPIONSHIP TUTORIAL</div>
      <div style="text-align: left; color: white; margin-bottom: 20px;">
        <h3>2 PLAYER MODE:</h3>
        <p>‚Ä¢ Left Player: Use W/S keys to move up/down</p>
        <p>‚Ä¢ Right Player: Use Arrow Up/Down keys to move</p>
        <p>‚Ä¢ Press E (Left) or Arrow Left (Right) for Power Shots when charged</p>
        
        <h3>4 PLAYER MODE:</h3>
        <p>‚Ä¢ Left Top: W/S keys</p>
        <p>‚Ä¢ Left Bottom: Q/A keys</p>
        <p>‚Ä¢ Right Top: O/L keys</p>
        <p>‚Ä¢ Right Bottom: Arrow Up/Down keys</p>
        <p>‚Ä¢ Press Z (Left Team) or K (Right Team) for Team Power Shots</p>
        
        <h3>MOBILE CONTROLS:</h3>
        <p>‚Ä¢ Use on-screen buttons to move paddles</p>
        <p>‚Ä¢ Tap power buttons when charged for special shots</p>
        
        <h3>GAME MECHANICS:</h3>
        <p>‚Ä¢ Power bar fills automatically over time</p>
        <p>‚Ä¢ When full, activate power shot for a super-fast return</p>
        <p>‚Ä¢ Ball speeds up with each hit</p>
        <p>‚Ä¢ First to 10 points wins (with bonus points in deuce situations)</p>
      </div>
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="closeTutorial">CLOSE</button>
      </div>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="backgroundMusic" loop></audio>
  <audio id="scoreSound"></audio>
  <audio id="scoreSound1"></audio>
  <audio id="scoreSound2"></audio>
  <audio id="hitSound"></audio>
  <audio id="hitSound1"></audio>
  <audio id="hitSound2"></audio>
  <audio id="hitSound3"></audio>
  <audio id="hitSound4"></audio>
  <audio id="etSound"></audio>
  <audio id="gameOverSound"></audio>
  <audio id="gameOverSound1"></audio>
  <audio id="selectSound"></audio>
  <audio id="startSound"></audio>
  <audio id="startSound1"></audio>
  <audio id="startSound2"></audio>
  <audio id="startSound3"></audio>
  <audio id="introSound"></audio>
  <audio id="introSound1"></audio>
  <audio id="introSound2"></audio>
  <audio id="introSound3"></audio>
  <audio id="confettiSound"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Game Constants
    const PADDLE_HEIGHT_RATIO = 0.2;
    const FOUR_PLAYER_PADDLE_HEIGHT_RATIO = 0.15;
    const BALL_RADIUS_RATIO = 0.012;
    const INITIAL_BALL_SPEED = 9;
    const MAX_BALL_SPEED = 16;
    const FOUR_PLAYER_BALL_SPEED = 10;
    const PADDLE_SPEED = 10;
    const WINNING_SCORE = 10;
    const HALF_TIME = 90;
    const HALF_TIME_BREAK = 10;
    const OVERTIME_TIME = 30;
    const BALL_SPEED_INCREMENT = 0.7;
    const SMASH_SPEED_MULTIPLIER = 2.0;
    const SMASH_DURATION = 800;
    const CHARGE_TIME = 4000;
    const POWER_SHOT_DURATION = 3000;
    
    // Game Elements
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');
    
    // Audio Elements
    const backgroundMusic = document.getElementById('backgroundMusic');
    const scoreSound = document.getElementById('scoreSound');
    const scoreSound1 = document.getElementById('scoreSound1');
    const scoreSound2 = document.getElementById('scoreSound2');
    const hitSound = document.getElementById('hitSound');
    const hitSound1 = document.getElementById('hitSound1');
    const hitSound2 = document.getElementById('hitSound2');
    const hitSound3 = document.getElementById('hitSound3');
    const hitSound4 = document.getElementById('hitSound4');
    const etSound = document.getElementById('etSound');
    const gameOverSound = document.getElementById('gameOverSound');
    const gameOverSound1 = document.getElementById('gameOverSound1');
    const selectSound = document.getElementById('selectSound');
    const startSound = document.getElementById('startSound');
    const startSound1 = document.getElementById('startSound1');
    const startSound2 = document.getElementById('startSound2');
    const startSound3 = document.getElementById('startSound3');
    const introSound = document.getElementById('introSound');
    const introSound1 = document.getElementById('introSound1');
    const introSound2 = document.getElementById('introSound2');
    const introSound3 = document.getElementById('introSound3');
    const confettiSound = document.getElementById('confettiSound');
    
    // Game State
    const game = {
      ball: { x: 0, y: 0, dx: 0, dy: 0, speed: INITIAL_BALL_SPEED, originalSpeed: INITIAL_BALL_SPEED },
      leftPaddle: { y: 0, score: 0 },
      rightPaddle: { y: 0, score: 0 },
      leftTopPaddle: { y: 0 },
      leftBottomPaddle: { y: 0 },
      rightTopPaddle: { y: 0 },
      rightBottomPaddle: { y: 0 },
      isFourPlayer: false,
      isMuted: false,
      isMusicMuted: false,
      isPaused: false,
      gameStarted: false,
      remainingTime: HALF_TIME,
      currentHalf: 1,
      extraTime: 0,
      halftimeActive: false,
      lastScorer: null,
      matchPoint: false,
      leftPlayer: "PLAYER 1",
      rightPlayer: "PLAYER 2",
      tournamentStage: "Round of 16",
      aiDifficulty: "easy",
      timerInterval: null,
      countdownInterval: null,
      halftimeInterval: null,
      keysPressed: {},
      bonusPoints: 0,
      deuceActive: false,
      startTime: 0,
      pausedTime: 0,
      commentaryQueue: [],
      isSpeaking: false,
      hasAnnounced30: false,
      hasAnnounced10: false,
      currentUtterance: null,
      lastSpecialMoveTime: 0,
      betweenPointsTimeout: null,
      mobileControls: {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false,
        leftPower: false,
        rightPower: false
      },
      dpadEnabled: false,
      isLocalMultiplayer: false,
      paddleWidth: 0,
      paddleHeight: 0,
      fourPlayerPaddleHeight: 0,
      ballRadius: 0,
      musicStarted: false,
      smashCounter: 0,
      smashTarget: 0,
      isSmashActive: false,
      smashEndTime: 0,
      recentPlays: [],
      bestWins: [],
      botChampions: [],
      leftCharge: 0,
      rightCharge: 0,
      leftCharged: false,
      rightCharged: false,
      leftChargeInterval: null,
      rightChargeInterval: null,
      leftChargeEndTime: 0,
      rightChargeEndTime: 0,
      countdownActive: false,
      last10Seconds: false,
      countdownNumbers: [],
      soundEnabled: false,
      teamLeftCharged: false,
      teamRightCharged: false,
      isPracticeMode: false,
      practiceType: null,
      isEndlessMode: false,
      ballResetTimeout: null,
      leftPaddleColor: 'white',
      rightPaddleColor: 'white',
      ballColor: 'white',
      practiceWins: 0,
      showScore: true,
      enableCommentary: true,
      opponentIsBot: true,
      fireTrails: [],
      confettiElements: [],
      lastPaddleSoundTime: 0,
      paddleSoundInterval: 200,
      gameMode: null,
      pausedBallState: null,
      pausedPaddleState: null,
      gameActive: false, // NEW: Track if game is actively playing (after countdown)
      halftimeBreakActive: false, // NEW: Track halftime break
      milliseconds: 0, // NEW: Track milliseconds
      lastTimerUpdate: 0 // NEW: For tracking timer updates
    };

    // Commentary phrases
    const commentaryPhrases = [
      "What a shot!",
      "Incredible reflexes!",
      "The crowd is going wild!",
      "This is championship-level play!",
      "Unbelievable!",
      "Did you see that?!",
      "The tension is palpable!",
      "What a rally!",
      "This match is heating up!",
      "A masterclass in pong!",
      "The players are giving it their all!",
      "This is pong at its finest!",
      "The stakes couldn't be higher!",
      "What a display of skill!",
      "The championship is on the line!",
      "This is what we came to see!",
      "The intensity is through the roof!",
      "Absolutely breathtaking play!",
      "The crowd can't believe their eyes!",
      "This is edge-of-your-seat action!",
      "The players are in the zone!",
      "What a back-and-forth battle!",
      "The energy in the arena is electric!",
      "This is pong perfection!",
      "The skill level is off the charts!",
      "Neither player is backing down!",
      "The determination is incredible!",
      "This is a clash of titans!",
      "The focus is laser-sharp!",
      "Every point is a masterpiece!",
      "The competition is fierce!",
      "This is next-level pong!",
      "The players are pushing their limits!",
      "The crowd is on their feet!",
      "This is a legendary match!",
      "The speed is mind-blowing!",
      "The precision is surgical!",
      "This is pong at warp speed!",
      "The reflexes are superhuman!",
      "The crowd is losing their minds!",
      "This is the match of the century!",
      "The players are unstoppable!",
      "The excitement is unbearable!",
      "This is pong poetry in motion!",
      "The anticipation is killing me!",
      "The players are putting on a clinic!",
      "This is a masterclass in competition!",
      "The drama is intense!",
      "The crowd is roaring with excitement!",
      "This is pong at its absolute best!"
    ];

    // Initialize Game
    function initGame() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      setupMobileControls();
      setupKeyboardControls();
      setupControlButtons();
      loadAudioFiles();
      loadLeaderboards();
      setupEventListeners();
      
      // Set up intro screen
      setupIntroScreen();
      
      // Enable sound by default
      game.soundEnabled = true;
      
      // Show What's New button only on title screen
      document.getElementById('whatsNewButton').style.display = 'block';
    }

    function setupIntroScreen() {
      // Animate the intro text
      const introText = document.getElementById('introText');
      const startButton = document.getElementById('startButton');
      
      // Enhanced intro animation with glowing text
      setTimeout(() => {
        introText.style.animation = 'textEntry 1s forwards, textGlow 2s infinite alternate';
        
        setTimeout(() => {
          startButton.style.animation = 'textEntry 0.5s forwards';
          startButton.style.animationDelay = '0.3s';
        }, 500);
      }, 300);
      
      startButton.addEventListener('click', () => {
        createConfetti(true);
        document.getElementById('introAnimation').style.display = 'none';
        document.getElementById('titleScreen').style.display = 'flex';
        
        // Play random intro sound only when button is clicked
        const introSounds = [introSound, introSound1, introSound2, introSound3];
        const randomIntroSound = introSounds[Math.floor(Math.random() * introSounds.length)];
        randomIntroSound.volume = 0.5;
        randomIntroSound.play().catch(e => console.log("Audio play error:", e));
      });
    }

    function setupButtonSounds() {
      const buttons = document.querySelectorAll('button, .btn-championship, .control-btn, .modal-btn, .stage-btn, .difficulty-btn');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          if (game.soundEnabled && !game.isMuted) {
            selectSound.currentTime = 0;
            selectSound.play().catch(e => console.log("Audio play error:", e));
          }
        });
      });
    }

    function setupEventListeners() {
      // Menu buttons
      document.getElementById('twoPlayerButton').addEventListener('click', showTwoPlayerPrompt);
      document.getElementById('singlePlayerButton').addEventListener('click', showSinglePlayerPrompt);
      document.getElementById('fourPlayerButton').addEventListener('click', showFourPlayerPrompt);
      document.getElementById('practiceButton').addEventListener('click', showPracticePrompt);
      document.getElementById('endlessButton').addEventListener('click', showEndlessPrompt);
      document.getElementById('leaderboardButton').addEventListener('click', showLeaderboards);
      document.getElementById('backToMenuButton').addEventListener('click', hideLeaderboards);
      document.getElementById('tutorialButton').addEventListener('click', showTutorial);
      
      // Modal submit buttons
      document.getElementById('submitTwoPlayerNames').addEventListener('click', submitTwoPlayerNames);
      document.getElementById('submitSinglePlayerName').addEventListener('click', submitSinglePlayerName);
      document.getElementById('submitFourPlayerNames').addEventListener('click', submitFourPlayerNames);
      document.getElementById('submitEndlessName').addEventListener('click', submitEndlessName);
      document.getElementById('learnPowerShotBtn').addEventListener('click', startPowerShotPractice);
      document.getElementById('learnRespondingBtn').addEventListener('click', startRespondingPractice);
      document.getElementById('practiceContinue').addEventListener('click', hidePracticeInstructions);
      document.getElementById('closeWhatsNew').addEventListener('click', () => {
        document.getElementById('whatsNewModal').style.display = 'none';
      });
      document.getElementById('closeTutorial').addEventListener('click', () => {
        document.getElementById('tutorialModal').style.display = 'none';
      });
      
      // Modal cancel buttons
      document.getElementById('cancelTwoPlayer').addEventListener('click', cancelTwoPlayerPrompt);
      document.getElementById('cancelSinglePlayer').addEventListener('click', cancelSinglePlayerPrompt);
      document.getElementById('cancelFourPlayer').addEventListener('click', cancelFourPlayerPrompt);
      document.getElementById('cancelEndless').addEventListener('click', cancelEndlessPrompt);
      document.getElementById('cancelPractice').addEventListener('click', cancelPracticePrompt);
      
      // Game control buttons
      document.getElementById('resumeButton').addEventListener('click', togglePause);
      document.getElementById('returnToMenuButton').addEventListener('click', returnToMenu);
      document.getElementById('endScreenBtn').addEventListener('click', returnToMenu);
      document.getElementById('backButton').addEventListener('click', handleBackButton);
      document.getElementById('whatsNewButton').addEventListener('click', showWhatsNew);
      
      // D-Pad controls
      document.getElementById('dpadUpLeft').addEventListener('touchstart', () => game.keysPressed['w'] = true);
      document.getElementById('dpadUpLeft').addEventListener('touchend', () => game.keysPressed['w'] = false);
      document.getElementById('dpadDownLeft').addEventListener('touchstart', () => game.keysPressed['s'] = true);
      document.getElementById('dpadDownLeft').addEventListener('touchend', () => game.keysPressed['s'] = false);
      document.getElementById('dpadPowerLeft').addEventListener('touchstart', () => {
        if (!game.leftCharged && game.leftCharge >= 100) {
          activateLeftPowerShot();
        }
      });
      
      document.getElementById('dpadUpRight').addEventListener('touchstart', () => game.keysPressed['ArrowUp'] = true);
      document.getElementById('dpadUpRight').addEventListener('touchend', () => game.keysPressed['ArrowUp'] = false);
      document.getElementById('dpadDownRight').addEventListener('touchstart', () => game.keysPressed['ArrowDown'] = true);
      document.getElementById('dpadDownRight').addEventListener('touchend', () => game.keysPressed['ArrowDown'] = false);
      document.getElementById('dpadPowerRight').addEventListener('touchstart', () => {
        if (!game.rightCharged && game.rightCharge >= 100) {
          activateRightPowerShot();
        }
      });
      
      document.getElementById('dpadUpLeft').addEventListener('mousedown', () => game.keysPressed['w'] = true);
      document.getElementById('dpadUpLeft').addEventListener('mouseup', () => game.keysPressed['w'] = false);
      document.getElementById('dpadDownLeft').addEventListener('mousedown', () => game.keysPressed['s'] = true);
      document.getElementById('dpadDownLeft').addEventListener('mouseup', () => game.keysPressed['s'] = false);
      document.getElementById('dpadPowerLeft').addEventListener('mousedown', () => {
        if (!game.leftCharged && game.leftCharge >= 100) {
          activateLeftPowerShot();
        }
      });
      
      document.getElementById('dpadUpRight').addEventListener('mousedown', () => game.keysPressed['ArrowUp'] = true);
      document.getElementById('dpadUpRight').addEventListener('mouseup', () => game.keysPressed['ArrowUp'] = false);
      document.getElementById('dpadDownRight').addEventListener('mousedown', () => game.keysPressed['ArrowDown'] = true);
      document.getElementById('dpadDownRight').addEventListener('mouseup', () => game.keysPressed['ArrowDown'] = false);
      document.getElementById('dpadPowerRight').addEventListener('mousedown', () => {
        if (!game.rightCharged && game.rightCharge >= 100) {
          activateRightPowerShot();
        }
      });
      
      // Opponent toggle in Endless mode
      document.getElementById('opponentToggle').addEventListener('change', function() {
        game.opponentIsBot = !this.checked;
      });
      
      // Leaderboard tabs
      const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
      leaderboardTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          leaderboardTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.leaderboard').forEach(lb => {
            lb.classList.remove('active');
          });
          
          const targetId = this.dataset.tab + (this.dataset.tab === 'best' ? 'Wins' : this.dataset.tab === 'bot' ? 'Champion' : 'Plays');
          document.getElementById(targetId).classList.add('active');
          playSelectSound();
        });
      });
      
      // Stage selection
      const stageBtns = document.querySelectorAll('.stage-btn');
      stageBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          stageBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('selectedStage').value = this.dataset.stage;
          playSelectSound();
        });
      });
      // Activate first stage by default
      if (stageBtns[0]) stageBtns[0].classList.add('active');
      
      // Difficulty selection
      const difficultyBtns = document.querySelectorAll('.difficulty-btn');
      difficultyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          difficultyBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const difficultyInput = document.getElementById(this.parentElement.nextElementSibling.id);
          if (difficultyInput) {
            difficultyInput.value = this.dataset.difficulty;
          }
          playSelectSound();
        });
      });
      
      // Setup button sounds
      setupButtonSounds();
    }

    function showTutorial() {
      document.getElementById('tutorialModal').style.display = 'flex';
      playSelectSound();
    }

    function showWhatsNew() {
      document.getElementById('whatsNewModal').style.display = 'flex';
      playSelectSound();
    }

    function showLeaderboards() {
      document.getElementById('titleScreen').style.display = 'none';
      document.getElementById('leaderboardScreen').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('whatsNewButton').style.display = 'none';
      updateLeaderboards();
      playSelectSound();
    }

    function hideLeaderboards() {
      document.getElementById('leaderboardScreen').style.display = 'none';
      document.getElementById('titleScreen').style.display = 'flex';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'block';
      playSelectSound();
    }

    function handleBackButton() {
      if (document.getElementById('twoPlayerPrompt').style.display === 'flex') {
        cancelTwoPlayerPrompt();
      } else if (document.getElementById('singlePlayerPrompt').style.display === 'flex') {
        cancelSinglePlayerPrompt();
      } else if (document.getElementById('fourPlayerPrompt').style.display === 'flex') {
        cancelFourPlayerPrompt();
      } else if (document.getElementById('endlessPrompt').style.display === 'flex') {
        cancelEndlessPrompt();
      } else if (document.getElementById('practiceModePrompt').style.display === 'flex') {
        cancelPracticePrompt();
      } else if (document.getElementById('leaderboardScreen').style.display === 'flex') {
        hideLeaderboards();
      } else if (document.getElementById('whatsNewModal').style.display === 'flex') {
        document.getElementById('whatsNewModal').style.display = 'none';
      } else if (document.getElementById('tutorialModal').style.display === 'flex') {
        document.getElementById('tutorialModal').style.display = 'none';
      } else {
        returnToMenu();
      }
    }

    function playSelectSound() {
      if (game.soundEnabled && !game.isMuted) {
        selectSound.currentTime = 0;
        selectSound.play().catch(e => console.log("Audio play error:", e));
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
          // Enter fullscreen
          if (document.documentElement.requestFullscreen) {
              document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) { // Safari
              document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) { // IE11
              document.documentElement.msRequestFullscreen();
          }
      } else {
          // Exit fullscreen
          if (document.exitFullscreen) {
              document.exitFullscreen();
          } else if (document.webkitExitFullscreen) { // Safari
              document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) { // IE11
              document.msExitFullscreen();
          }
      }
    }

    function loadLeaderboards() {
      // Load from localStorage if available
      if (localStorage.getItem('pongRecentPlays')) {
        game.recentPlays = JSON.parse(localStorage.getItem('pongRecentPlays'));
      }
      
      if (localStorage.getItem('pongBestWins')) {
        game.bestWins = JSON.parse(localStorage.getItem('pongBestWins'));
      }
      
      if (localStorage.getItem('pongBotChampions')) {
        game.botChampions = JSON.parse(localStorage.getItem('pongBotChampions'));
      }
      
      updateLeaderboards();
    }

    function updateLeaderboards() {
      // Recent Plays - now includes bot matches
      const recentPlaysList = document.getElementById('recentPlaysList');
      if (recentPlaysList) {
        recentPlaysList.innerHTML = '';
        
        game.recentPlays.slice(0, 10).forEach((play, index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          const opponent = play.player2 === "BOT" ? "BOT" : play.player2;
          const timeAgo = getTimeAgo(play.timestamp);
          const difficulty = play.difficulty ? ` (${play.difficulty.toUpperCase()})` : '';
          item.innerHTML = `<strong>${play.player1}</strong> vs <strong>${opponent}${difficulty}</strong><br>
                           ${play.stage || "Match"} - ${play.score1}-${play.score2}
                           <div class="leaderboard-time">${timeAgo}</div>`;
          recentPlaysList.appendChild(item);
        });
      }
      
      // Best Wins
      const bestWinsList = document.getElementById('bestWinsList');
      if (bestWinsList) {
        bestWinsList.innerHTML = '';
        
        game.bestWins.sort((a, b) => (b.score1 - b.score2) - (a.score1 - a.score2)).slice(0, 10).forEach((win, index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          const timeAgo = getTimeAgo(win.timestamp);
          const difficulty = win.difficulty ? ` (${win.difficulty.toUpperCase()})` : '';
          item.innerHTML = `<span class="leaderboard-rank">${index + 1}.</span> 
                           <strong>${win.player1}</strong> ${win.score1}-${win.score2} <strong>${win.player2}${difficulty}</strong>
                           <div class="leaderboard-time">${timeAgo}</div>`;
          bestWinsList.appendChild(item);
        });
      }
      
      // Bot Champions
      const botChampionList = document.getElementById('botChampionList');
      if (botChampionList) {
        botChampionList.innerHTML = '';
        
        game.botChampions.sort((a, b) => (b.score1 - b.score2) - (a.score1 - a.score2)).slice(0, 20).forEach((champ, index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          const timeAgo = getTimeAgo(champ.timestamp);
          const difficulty = champ.difficulty ? ` (${champ.difficulty.toUpperCase()})` : '';
          item.innerHTML = `<span class="leaderboard-rank">${index + 1}.</span> 
                           <strong>${champ.player1}</strong> ${champ.score1}-${champ.score2} BOT${difficulty}
                           <div class="leaderboard-time">${timeAgo}</div>`;
          botChampionList.appendChild(item);
        });
      }
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      
      if (seconds < 60) return `${seconds} sec ago`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hr ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}D ago`;
      if (seconds < 2592000) return `${Math.floor(seconds / 604800)}W ago`;
      if (seconds < 31536000) return `${Math.floor(seconds / 2592000)}M ago`;
      return `${Math.floor(seconds / 31536000)} yr ago`;
    }

    function saveToLeaderboard(type, data) {
      if (type === 'recent') {
        game.recentPlays.unshift(data);
        if (game.recentPlays.length > 50) game.recentPlays.pop();
        localStorage.setItem('pongRecentPlays', JSON.stringify(game.recentPlays));
      } 
      else if (type === 'best') {
        game.bestWins.push(data);
        if (game.bestWins.length > 50) game.bestWins.pop();
        localStorage.setItem('pongBestWins', JSON.stringify(game.bestWins));
      }
      else if (type === 'bot') {
        game.botChampions.push(data);
        if (game.botChampions.length > 50) game.botChampions.pop();
        localStorage.setItem('pongBotChampions', JSON.stringify(game.botChampions));
      }
      
      updateLeaderboards();
    }

    // Setup functions
    function resizeCanvas() {
      // Set canvas to full window size
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      // Calculate dynamic sizes based on canvas dimensions
      game.paddleWidth = Math.max(15, canvas.width * 0.015);
      game.paddleHeight = canvas.height * PADDLE_HEIGHT_RATIO;
      game.fourPlayerPaddleHeight = canvas.height * FOUR_PLAYER_PADDLE_HEIGHT_RATIO;
      game.ballRadius = Math.max(8, canvas.width * BALL_RADIUS_RATIO);
      
      // Reset game elements if game is already started
      if (game.gameStarted) {
        resetBall();
        resetPaddles();
      }
    }

    function setupMobileControls() {
      const upBtnLeft = document.getElementById('upBtnLeft');
      const downBtnLeft = document.getElementById('downBtnLeft');
      const upBtnRight = document.getElementById('upBtnRight');
      const rightPowerBtn = document.getElementById('rightPowerBtn');
      
      // Touch events
      const handleTouch = (btn, direction, isLeft) => (e) => {
        e.preventDefault();
        if (isLeft) {
          game.mobileControls.leftUp = direction === 'up';
          game.mobileControls.leftDown = direction === 'down';
        } else {
          game.mobileControls.rightUp = direction === 'up';
          game.mobileControls.rightDown = direction === 'down';
        }
      };
      
      if (upBtnLeft) upBtnLeft.addEventListener('touchstart', handleTouch(upBtnLeft, 'up', true));
      if (upBtnLeft) upBtnLeft.addEventListener('touchend', handleTouch(upBtnLeft, 'none', true));
      if (downBtnLeft) downBtnLeft.addEventListener('touchstart', handleTouch(downBtnLeft, 'down', true));
      if (downBtnLeft) downBtnLeft.addEventListener('touchend', handleTouch(downBtnLeft, 'none', true));
      if (upBtnRight) upBtnRight.addEventListener('touchstart', handleTouch(upBtnRight, 'up', false));
      if (upBtnRight) upBtnRight.addEventListener('touchend', handleTouch(upBtnRight, 'none', false));
      
      // Power buttons
      if (rightPowerBtn) rightPowerBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (!game.rightCharged && game.rightCharge >= 100) {
          activateRightPowerShot();
        }
      });
      
      // Mouse events for desktop testing
      if (upBtnLeft) upBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftUp = true);
      if (upBtnLeft) upBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftUp = false);
      if (downBtnLeft) downBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftDown = true);
      if (downBtnLeft) downBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftDown = false);
      if (upBtnRight) upBtnRight.addEventListener('mousedown', () => game.mobileControls.rightUp = true);
      if (upBtnRight) upBtnRight.addEventListener('mouseup', () => game.mobileControls.rightUp = false);
      if (rightPowerBtn) rightPowerBtn.addEventListener('mousedown', () => {
        if (!game.rightCharged && game.rightCharge >= 100) {
          activateRightPowerShot();
        }
      });
    }

    function setupKeyboardControls() {
      // Handle both keydown and keypress events for better iPad compatibility
      document.addEventListener('keydown', handleKeyEvent);
      document.addEventListener('keypress', handleKeyEvent);
    }

    function handleKeyEvent(e) {
      switch(e.key) {
        case 'w':
        case 'W':
          game.keysPressed['w'] = true;
          break;
        case 's':
        case 'S':
          game.keysPressed['s'] = true;
          break;
        case 'ArrowUp':
          game.keysPressed['ArrowUp'] = true;
          break;
        case 'ArrowDown':
          game.keysPressed['ArrowDown'] = true;
          break;
        case 'q':
        case 'Q':
          game.keysPressed['q'] = true;
          break;
        case 'a':
        case 'A':
          game.keysPressed['a'] = true;
          break;
        case 'o':
        case 'O':
          game.keysPressed['o'] = true;
          break;
        case 'l':
        case 'L':
          game.keysPressed['l'] = true;
          break;
        case 'e':
        case 'E':
          if (!game.leftCharged && game.leftCharge >= 100 && !game.isFourPlayer) {
            activateLeftPowerShot();
          }
          break;
        case 'ArrowLeft':
          if (!game.rightCharged && game.rightCharge >= 100 && !game.isFourPlayer) {
            activateRightPowerShot();
          }
          break;
        case 'z':
        case 'Z':
          if (game.isFourPlayer && !game.teamLeftCharged && game.leftCharge >= 100) {
            activateTeamLeftPowerShot();
          }
          break;
        case 'k':
        case 'K':
          if (game.isFourPlayer && !game.teamRightCharged && game.rightCharge >= 100) {
            activateTeamRightPowerShot();
          }
          break;
      }
    }

    document.addEventListener('keyup', (e) => {
      switch(e.key) {
        case 'w':
        case 'W':
          game.keysPressed['w'] = false;
          break;
        case 's':
        case 'S':
          game.keysPressed['s'] = false;
          break;
        case 'ArrowUp':
          game.keysPressed['ArrowUp'] = false;
          break;
        case 'ArrowDown':
          game.keysPressed['ArrowDown'] = false;
          break;
        case 'q':
        case 'Q':
          game.keysPressed['q'] = false;
          break;
        case 'a':
        case 'A':
          game.keysPressed['a'] = false;
          break;
        case 'o':
        case 'O':
          game.keysPressed['o'] = false;
          break;
        case 'l':
        case 'L':
          game.keysPressed['l'] = false;
          break;
      }
    });

    function setupControlButtons() {
      const muteButton = document.getElementById('muteButton');
      const pauseButton = document.getElementById('pauseButton');
      const fullscreenButton = document.getElementById('fullscreenButton');
      const musicMuteButton = document.getElementById('musicMuteButton');
      
      if (muteButton) muteButton.addEventListener('click', toggleMute);
      if (pauseButton) pauseButton.addEventListener('click', togglePause);
      if (fullscreenButton) fullscreenButton.addEventListener('click', toggleFullscreen);
      if (musicMuteButton) musicMuteButton.addEventListener('click', toggleMusicMute);
    }

    function loadAudioFiles() {
      // Preload sound effects
      scoreSound.src = 'score.mp3';
      scoreSound1.src = 'score1.mp3';
      scoreSound2.src = 'score2.mp3';
      hitSound.src = 'hit.mp3';
      hitSound1.src = 'hit1.mp3';
      hitSound2.src = 'hit2.mp3';
      hitSound3.src = 'hit3.mp3';
      hitSound4.src = 'hit4.mp3';
      etSound.src = 'et.mp3';
      gameOverSound.src = 'gameover.mp3';
      gameOverSound1.src = 'gameover1.mp3';
      selectSound.src = 'select.mp3';
      startSound.src = 'start.mp3';
      startSound1.src = 'start1.mp3';
      startSound2.src = 'start2.mp3';
      startSound3.src = 'start3.mp3';
      introSound.src = 'intro.mp3';
      introSound1.src = 'intro1.mp3';
      introSound2.src = 'intro2.mp3';
      introSound3.src = 'intro3.mp3';
      confettiSound.src = 'confetti.mp3';
    }

    function playRandomStartMusic() {
      if (!game.soundEnabled || game.isMusicMuted) return;
      
      const startTracks = [startSound, startSound1, startSound2, startSound3];
      const randomTrack = startTracks[Math.floor(Math.random() * startTracks.length)];
      
      randomTrack.currentTime = 0;
      randomTrack.volume = 0.5;
      randomTrack.play().catch(e => console.log("Audio play error:", e));
      
      randomTrack.onended = function() {
        playRandomGameMusic();
      };
    }

    function playRandomGameMusic() {
      if (!game.soundEnabled || game.isMusicMuted || !game.musicStarted) return;
      
      const musicTracks = ['music1.mp3', 'music2.mp3', 'music3.mp3', 'music4.mp3', 'music5.mp3', 'music6.mp3'];
      const randomTrack = musicTracks[Math.floor(Math.random() * musicTracks.length)];
      backgroundMusic.src = randomTrack;
      backgroundMusic.volume = 0.3;
      backgroundMusic.play().catch(e => console.log("Audio play error:", e));
      
      backgroundMusic.onended = function() {
        playRandomGameMusic();
      };
    }

    function playRandomScoreSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      const sounds = [scoreSound, scoreSound1, scoreSound2];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playRandomHitSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      const sounds = [hitSound, hitSound1, hitSound2, hitSound3, hitSound4];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playGameOverSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      const sounds = [gameOverSound, gameOverSound1];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.volume = 0.5;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playETSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      etSound.currentTime = 0;
      etSound.volume = 0.5;
      etSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playConfettiSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      confettiSound.currentTime = 0;
      confettiSound.volume = 0.3;
      confettiSound.play().catch(e => console.log("Audio play error:", e));
    }

    // Game logic functions
    function resetBall() {
      game.ball.x = canvas.width / 2;
      game.ball.y = canvas.height / 2;
      game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      game.ball.originalSpeed = game.ball.speed;
      game.ball.dx = Math.random() > 0.5 ? game.ball.speed * 0.6 : -game.ball.speed * 0.6;
      game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed * 0.6;
      
      // Reset smash counter
      game.smashCounter = 0;
      game.smashTarget = Math.floor(Math.random() * 5) + 3;
      
      // Set ball color to white
      game.ballColor = 'white';
      
      // Make sure ball is visible
      game.ball.x = Math.max(game.ballRadius, Math.min(canvas.width - game.ballRadius, game.ball.x));
      game.ball.y = Math.max(game.ballRadius, Math.min(canvas.height - game.ballRadius, game.ball.y));
    }

    function startBallAfterCountdown() {
      // Set random direction for the ball after countdown
      game.ball.dx = Math.random() > 0.5 ? game.ball.speed * 0.6 : -game.ball.speed * 0.6;
      game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed * 0.6;
    }

    function resetPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      const centerY = (canvas.height - paddleHeight) / 2;
      
      game.leftPaddle.y = centerY;
      game.rightPaddle.y = centerY;
      
      // Set paddle colors to white
      game.leftPaddleColor = 'white';
      game.rightPaddleColor = 'white';
      
      if (game.isFourPlayer) {
        game.leftTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.leftBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
        game.rightTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.rightBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
      }
    }

    function constrainPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        game.leftPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftPaddle.y));
        game.rightPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightPaddle.y));
      } else {
        game.leftTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftTopPaddle.y));
        game.leftBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftBottomPaddle.y));
        game.rightTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightTopPaddle.y));
        game.rightBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightBottomPaddle.y));
      }
    }

    function startLeftCharge() {
      if (game.leftChargeInterval) clearInterval(game.leftChargeInterval);
      
      game.leftCharge = 0;
      const leftChargeElement = document.getElementById('leftCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      
      if (leftChargeElement) leftChargeElement.style.width = '0';
      if (leftChargeElement) leftChargeElement.classList.remove('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
      
      game.leftChargeInterval = setInterval(() => {
        game.leftCharge += 100 / (CHARGE_TIME / 100);
        if (leftChargeElement) leftChargeElement.style.width = `${game.leftCharge}%`;
        
        if (game.leftCharge >= 100) {
          clearInterval(game.leftChargeInterval);
          if (leftChargeElement) leftChargeElement.classList.add('active');
          if (leftChargeLabel) leftChargeLabel.textContent = 'P1 READY!';
        }
      }, 100);
    }

    function startRightCharge() {
      if (game.rightChargeInterval) clearInterval(game.rightChargeInterval);
      
      game.rightCharge = 0;
      const rightChargeElement = document.getElementById('rightCharge');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (rightChargeElement) rightChargeElement.style.width = '0';
      if (rightChargeElement) rightChargeElement.classList.remove('active');
      if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
      
      game.rightChargeInterval = setInterval(() => {
        game.rightCharge += 100 / (CHARGE_TIME / 100);
        if (rightChargeElement) rightChargeElement.style.width = `${game.rightCharge}%`;
        
        if (game.rightCharge >= 100) {
          clearInterval(game.rightChargeInterval);
          if (rightChargeElement) rightChargeElement.classList.add('active');
          if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 READY!' : 'BOT READY!';
        }
      }, 100);
    }

    function activateLeftPowerShot() {
      game.leftCharged = true;
      game.leftChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const leftChargeElement = document.getElementById('leftCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      
      if (leftChargeElement) leftChargeElement.classList.add('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'P1 FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.leftChargeEndTime) {
          game.leftCharged = false;
          if (leftChargeElement) leftChargeElement.classList.remove('active');
          if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
          startLeftCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateRightPowerShot() {
      game.rightCharged = true;
      game.rightChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const rightChargeElement = document.getElementById('rightCharge');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (rightChargeElement) rightChargeElement.classList.add('active');
      if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 FIRING!' : 'BOT FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.rightChargeEndTime) {
          game.rightCharged = false;
          if (rightChargeElement) rightChargeElement.classList.remove('active');
          if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
          startRightCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateTeamLeftPowerShot() {
      game.teamLeftCharged = true;
      game.leftChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const leftChargeElement = document.getElementById('leftCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      
      if (leftChargeElement) leftChargeElement.classList.add('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'TEAM FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.leftChargeEndTime) {
          game.teamLeftCharged = false;
          if (leftChargeElement) leftChargeElement.classList.remove('active');
          if (leftChargeLabel) leftChargeLabel.textContent = 'TEAM POWER';
          startLeftCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateTeamRightPowerShot() {
      game.teamRightCharged = true;
      game.rightChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const rightChargeElement = document.getElementById('rightCharge');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (rightChargeElement) rightChargeElement.classList.add('active');
      if (rightChargeLabel) rightChargeLabel.textContent = 'TEAM FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.rightChargeEndTime) {
          game.teamRightCharged = false;
          if (rightChargeElement) rightChargeElement.classList.remove('active');
          if (rightChargeLabel) rightChargeLabel.textContent = 'TEAM POWER';
          startRightCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    // Drawing functions
    function drawPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        // Left paddle
        ctx.fillStyle = game.leftPaddleColor;
        ctx.shadowBlur = 0;
        
        if (game.leftCharged || (game.last10Seconds && game.lastScorer === game.leftPlayer)) {
          // Draw fire effect for powered paddle
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          addFireTrail(20 + game.paddleWidth, game.leftPaddle.y + paddleHeight/2, 'left');
        }
        ctx.fillRect(20, game.leftPaddle.y, game.paddleWidth, paddleHeight);
        
        // Right paddle
        ctx.fillStyle = game.rightPaddleColor;
        ctx.shadowBlur = 0;
        
        if (game.rightCharged || (game.last10Seconds && game.lastScorer === game.rightPlayer)) {
          // Draw fire effect for powered paddle
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          addFireTrail(canvas.width - 20, game.rightPaddle.y + paddleHeight/2, 'right');
        }
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightPaddle.y, game.paddleWidth, paddleHeight);
      } else {
        // 4-player paddles
        ctx.fillStyle = game.leftPaddleColor;
        ctx.shadowBlur = 0;
        
        // Left team (top and bottom)
        if (game.teamLeftCharged || (game.last10Seconds && game.lastScorer === game.leftPlayer)) {
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          addFireTrail(20 + game.paddleWidth, game.leftTopPaddle.y + paddleHeight/2, 'left');
          addFireTrail(20 + game.paddleWidth, game.leftBottomPaddle.y + paddleHeight/2, 'left');
        }
        ctx.fillRect(20, game.leftTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(20, game.leftBottomPaddle.y, game.paddleWidth, paddleHeight);
        
        // Right team (top and bottom)
        ctx.fillStyle = game.rightPaddleColor;
        ctx.shadowBlur = 0;
        
        if (game.teamRightCharged || (game.last10Seconds && game.lastScorer === game.rightPlayer)) {
          // Draw fire effect for powered paddle
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          addFireTrail(canvas.width - 20, game.rightTopPaddle.y + paddleHeight/2, 'right');
          addFireTrail(canvas.width - 20, game.rightBottomPaddle.y + paddleHeight/2, 'right');
        }
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightBottomPaddle.y, game.paddleWidth, paddleHeight);
      }
      ctx.shadowBlur = 0; // Reset shadow
    }

    function addFireTrail(x, y, side) {
      // Create a new fire trail element
      const fireTrail = document.createElement('div');
      fireTrail.className = 'fire-trail';
      fireTrail.style.left = `${x}px`;
      fireTrail.style.top = `${y}px`;
      fireTrail.style.backgroundColor = `hsl(${Math.random() * 30 + 20}, 100%, 50%)`;
      document.getElementById('gameContainer').appendChild(fireTrail);
      
      // Store reference for cleanup
      game.fireTrails.push({
        element: fireTrail,
        createdAt: Date.now()
      });
      
      // Clean up old fire trails (performance optimization)
      const now = Date.now();
      game.fireTrails = game.fireTrails.filter(trail => {
        if (now - trail.createdAt > 500) {
          trail.element.remove();
          return false;
        }
        return true;
      });
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(game.ball.x, game.ball.y, game.ballRadius, 0, Math.PI * 2);
      
      // Change ball color during smash or last 10 seconds
      if (game.isSmashActive || game.last10Seconds) {
        const gradient = ctx.createRadialGradient(
          game.ball.x, game.ball.y, 0,
          game.ball.x, game.ball.y, game.ballRadius
        );
        gradient.addColorStop(0, 'yellow');
        gradient.addColorStop(0.5, 'orange');
        gradient.addColorStop(1, 'red');
        ctx.fillStyle = gradient;
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'orange';
        
        // Add fire trail effect
        if (Math.random() < 0.3) {
          addFireTrail(game.ball.x, game.ball.y, game.ball.dx > 0 ? 'right' : 'left');
        }
      } else {
        ctx.fillStyle = game.ballColor;
        ctx.shadowBlur = 0;
      }
      
      ctx.fill();
      ctx.closePath();
      ctx.shadowBlur = 0; // Reset shadow
    }

    function drawNet() {
      ctx.setLineDash([8, 12]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Game loop functions
    function gameLoop(timestamp) {
      if (!game.gameStarted || game.isPaused || game.halftimeActive || !game.gameActive) {
        requestAnimationFrame(gameLoop);
        return;
      }

      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Calculate delta time for smooth animation
      const deltaTime = timestamp - game.lastFrameTime;
      game.lastFrameTime = timestamp;
      
      drawPaddles();
      drawBall();
      drawNet();

      updateBall(deltaTime);
      updatePaddles(deltaTime);
      checkCollisions();
      checkSmash();

      requestAnimationFrame(gameLoop);
    }

    function updateBall(deltaTime) {
      if (game.isPaused || game.halftimeActive || !game.gameActive) return;
      
      // Normalize speed based on frame rate
      const speedFactor = deltaTime / 16; // 16ms is ~60fps
      
      // Prevent ball from getting stuck at edges
      if (game.ball.y - game.ballRadius <= 0) {
        game.ball.y = game.ballRadius + 1;
        game.ball.dy = Math.abs(game.ball.dy);
      }
      
      if (game.ball.y + game.ballRadius >= canvas.height) {
        game.ball.y = canvas.height - game.ballRadius - 1;
        game.ball.dy = -Math.abs(game.ball.dy);
      }
      
      game.ball.x += game.ball.dx * speedFactor;
      game.ball.y += game.ball.dy * speedFactor;

      // Ball collision with top and bottom
      if (game.ball.y - game.ballRadius < 0 || game.ball.y + game.ballRadius > canvas.height) {
        game.ball.dy = -game.ball.dy;
      }
    }

    function updatePaddles(deltaTime) {
      if (game.isPaused || game.halftimeActive || !game.gameActive) return;

      // Normalize speed based on frame rate
      const speedFactor = deltaTime / 16;
      const paddleSpeed = PADDLE_SPEED * speedFactor;

      // Mobile controls
      if (game.mobileControls.leftUp) {
        game.leftPaddle.y -= paddleSpeed;
      }
      if (game.mobileControls.leftDown) {
        game.leftPaddle.y += paddleSpeed;
      }
      if (game.mobileControls.rightUp) {
        game.rightPaddle.y -= paddleSpeed;
      }
      if (game.mobileControls.rightDown) {
        game.rightPaddle.y += paddleSpeed;
      }
      
      // Mobile power buttons
      if (game.mobileControls.leftPower && !game.leftCharged && game.leftCharge >= 100) {
        activateLeftPowerShot();
      }
      if (game.mobileControls.rightPower && !game.rightCharged && game.rightCharge >= 100) {
        activateRightPowerShot();
      }

      // Keyboard controls
      if (!game.isFourPlayer) {
        if (game.isLocalMultiplayer || (game.isEndlessMode && !game.opponentIsBot)) {
          if (game.keysPressed['w'] || game.keysPressed['W']) {
            game.leftPaddle.y -= paddleSpeed;
          }
          if (game.keysPressed['s'] || game.keysPressed['S']) {
            game.leftPaddle.y += paddleSpeed;
          }
          if (game.keysPressed['ArrowUp']) {
            game.rightPaddle.y -= paddleSpeed;
          }
          if (game.keysPressed['ArrowDown']) {
            game.rightPaddle.y += paddleSpeed;
          }
        } else {
          // Player controls (including practice mode)
          if (game.keysPressed['w'] || game.keysPressed['W']) {
            game.leftPaddle.y -= paddleSpeed;
          }
          if (game.keysPressed['s'] || game.keysPressed['S']) {
            game.leftPaddle.y += paddleSpeed;
          }
          
          // AI for right paddle in single player, practice, or endless mode
          if (game.rightPlayer === "BOT" || game.isPracticeMode) {
            const paddleCenter = game.rightPaddle.y + game.paddleHeight / 2;
            const predictedBallY = game.ball.y + (game.ball.dy * (canvas.width - game.ball.x) / Math.abs(game.ball.dx || 1));
            
            // Adjust AI difficulty
            let reactionSpeed;
            switch(game.aiDifficulty) {
              case 'easy':
                reactionSpeed = 0.5 * (1 + Math.random() * 0.3 - 0.15);
                break;
              case 'hard':
                reactionSpeed = 0.9 * (1 + Math.random() * 0.1 - 0.05);
                break;
              default: // medium
                reactionSpeed = 0.7 * (1 + Math.random() * 0.2 - 0.1);
            }
            
            if (paddleCenter < predictedBallY - 15) {
              game.rightPaddle.y += paddleSpeed * reactionSpeed;
            } else if (paddleCenter > predictedBallY + 15) {
              game.rightPaddle.y -= paddleSpeed * reactionSpeed;
            }
            
            // AI power shot (only in non-practice modes)
            if (!game.isPracticeMode && !game.rightCharged && game.rightCharge >= 100 && Math.random() < 0.01) {
              activateRightPowerShot();
            }
          }
        }
      } else {
        // 4-player controls
        if (game.keysPressed['w'] || game.keysPressed['W']) {
          game.leftTopPaddle.y -= paddleSpeed;
        }
        if (game.keysPressed['s'] || game.keysPressed['S']) {
          game.leftTopPaddle.y += paddleSpeed;
        }
        if (game.keysPressed['q'] || game.keysPressed['Q']) {
          game.leftBottomPaddle.y -= paddleSpeed;
        }
        if (game.keysPressed['a'] || game.keysPressed['A']) {
          game.leftBottomPaddle.y += paddleSpeed;
        }
        if (game.keysPressed['o'] || game.keysPressed['O']) {
          game.rightTopPaddle.y -= paddleSpeed;
        }
        if (game.keysPressed['l'] || game.keysPressed['L']) {
          game.rightTopPaddle.y += paddleSpeed;
        }
        if (game.keysPressed['ArrowUp']) {
          game.rightBottomPaddle.y -= paddleSpeed;
        }
        if (game.keysPressed['ArrowDown']) {
          game.rightBottomPaddle.y += paddleSpeed;
        }
      }
      
      constrainPaddles();
    }

    function checkCollisions() {
      if (game.isPaused || game.halftimeActive || !game.gameActive) return;
      
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;

      // Ball collision with paddles
      if (!game.isFourPlayer) {
        // Left paddle collision
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth &&
            game.ball.y > game.leftPaddle.y &&
            game.ball.y < game.leftPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.leftPaddle.y, game.ball.y, paddleHeight);
          
          // Check for power shot - FIXED: Now properly applies speed multiplier
          if (game.leftCharged || game.last10Seconds) {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.leftCharged = false;
            const leftChargeElement = document.getElementById('leftCharge');
            const leftChargeLabel = document.getElementById('leftChargeLabel');
            if (leftChargeElement) leftChargeElement.classList.remove('active');
            if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
            startLeftCharge();
            if (!game.isPracticeMode && !game.isEndlessMode) {
              queueCommentary("POWER SHOT FROM " + game.leftPlayer + "!", true, true);
            } else if (game.isPracticeMode && game.practiceType === 'powershot') {
              game.practiceWins++;
              if (game.practiceWins >= 10) {
                queueCommentary("Good job! You have mastered power shots!", true, true);
                game.practiceWins = 0;
              }
            }
          } else {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.leftPlayer;
          playRandomHitSound();
        }
        
        // Right paddle collision
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth &&
            game.ball.y > game.rightPaddle.y &&
            game.ball.y < game.rightPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.rightPaddle.y, game.ball.y, paddleHeight);
          
          // Check for power shot - FIXED: Now properly applies speed multiplier
          if (game.rightCharged || game.last10Seconds) {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.rightCharged = false;
            const rightChargeElement = document.getElementById('rightCharge');
            const rightChargeLabel = document.getElementById('rightChargeLabel');
            if (rightChargeElement) rightChargeElement.classList.remove('active');
            if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
            startRightCharge();
            if (!game.isPracticeMode && !game.isEndlessMode) {
              queueCommentary("POWER SHOT FROM " + game.rightPlayer + "!", true, true);
            } else if (game.isPracticeMode && game.practiceType === 'responding') {
              game.practiceWins++;
              if (game.practiceWins >= 10) {
                queueCommentary("Excellent! You've mastered responding to shots!", true, true);
                game.practiceWins = 0;
              }
            }
          } else {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.rightPlayer;
          playRandomHitSound();
        }
      } else {
        // 4-player paddle collisions
        // Left side paddles
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth) {
          if ((game.ball.y > game.leftTopPaddle.y && game.ball.y < game.leftTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.leftBottomPaddle.y && game.ball.y < game.leftBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.leftTopPaddle : game.leftBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            
            // Check for team power shot
            if (game.teamLeftCharged || game.last10Seconds) {
              game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
              game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
              game.isSmashActive = true;
              game.smashEndTime = Date.now() + SMASH_DURATION;
              game.teamLeftCharged = false;
              const leftChargeElement = document.getElementById('leftCharge');
              const leftChargeLabel = document.getElementById('leftChargeLabel');
              if (leftChargeElement) leftChargeElement.classList.remove('active');
            if (leftChargeLabel) leftChargeLabel.textContent = 'TEAM POWER';
            startLeftCharge();
            queueCommentary("TEAM POWER SHOT FROM " + game.leftPlayer + "!", true, true);
          } else {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.leftPlayer;
          playRandomHitSound();
        }
      }
      
      // Right side paddles
      if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth) {
        if ((game.ball.y > game.rightTopPaddle.y && game.ball.y < game.rightTopPaddle.y + paddleHeight) ||
            (game.ball.y > game.rightBottomPaddle.y && game.ball.y < game.rightBottomPaddle.y + paddleHeight)) {
          const paddle = game.ball.y < canvas.height/2 ? game.rightTopPaddle : game.rightBottomPaddle;
          const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
          
          // Check for team power shot
          if (game.teamRightCharged || game.last10Seconds) {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.teamRightCharged = false;
            const rightChargeElement = document.getElementById('rightCharge');
            const rightChargeLabel = document.getElementById('rightChargeLabel');
            if (rightChargeElement) rightChargeElement.classList.remove('active');
            if (rightChargeLabel) rightChargeLabel.textContent = 'TEAM POWER';
            startRightCharge();
            queueCommentary("TEAM POWER SHOT FROM " + game.rightPlayer + "!", true, true);
          } else {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.rightPlayer;
          playRandomHitSound();
        }
      }
    }
    
    // Ball out of bounds - scoring
    if (game.ball.x - game.ballRadius < 0) {
      if (!game.isPracticeMode && !game.isEndlessMode) {
        game.rightPaddle.score++;
        document.getElementById('rightScore').textContent = game.rightPaddle.score;
        game.lastScorer = game.rightPlayer;
        handleScore();
      } else if (game.isPracticeMode) {
        // In practice mode, just reset the ball immediately
        resetBall();
        game.ball.dx = -Math.abs(game.ball.dx);
        if (game.practiceType === 'responding') {
          queueCommentary("Try again! Press E for a power shot!", true);
        }
      } else if (game.isEndlessMode) {
        if (game.showScore) {
          game.rightPaddle.score++;
          document.getElementById('rightScore').textContent = game.rightPaddle.score;
        }
        resetBall();
        game.ball.dx = -Math.abs(game.ball.dx);
      }
    }

    if (game.ball.x + game.ballRadius > canvas.width) {
      if (!game.isPracticeMode && !game.isEndlessMode) {
        game.leftPaddle.score++;
        document.getElementById('leftScore').textContent = game.leftPaddle.score;
        game.lastScorer = game.leftPlayer;
        handleScore();
      } else if (game.isPracticeMode || game.isEndlessMode) {
        // In practice/endless mode, just reset the ball immediately
        if (game.isEndlessMode && game.showScore) {
          game.leftPaddle.score++;
          document.getElementById('leftScore').textContent = game.leftPaddle.score;
        } else if (game.isPracticeMode) {
          game.leftPaddle.score++;
          document.getElementById('leftScore').textContent = game.leftPaddle.score;
        }
        resetBall();
        game.ball.dx = Math.abs(game.ball.dx);
        if (game.isPracticeMode && game.practiceType === 'powershot') {
          queueCommentary("Great! Now try again!", true);
        }
      }
    }

    // Deuce (tie) situation
    if (!game.isPracticeMode && !game.isEndlessMode) {
      if (game.leftPaddle.score >= 5 && game.rightPaddle.score >= 5 && 
          game.leftPaddle.score === game.rightPaddle.score && !game.deuceActive) {
        game.deuceActive = true;
        game.bonusPoints++;
        const bonusPointsElement = document.getElementById('bonusPoints');
        if (bonusPointsElement) bonusPointsElement.textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        queueCommentary("WE'RE AT DEUCE! BONUS POINT ACTIVATED! NEXT POINT WINS!", true, true);
      } else if (game.leftPaddle.score !== game.rightPaddle.score) {
        game.deuceActive = false;
      }
    }
  }

  function checkSmash() {
    if (game.isSmashActive && Date.now() > game.smashEndTime) {
      game.isSmashActive = false;
      
      // Return to original speed but maintain direction
      const angle = Math.atan2(game.ball.dy, game.ball.dx);
      game.ball.speed = game.ball.originalSpeed;
      game.ball.dx = Math.cos(angle) * game.ball.speed;
      game.ball.dy = Math.sin(angle) * game.ball.speed;
    }
  }

  function getBallAngle(paddleY, hitY, paddleHeight) {
    const relativeY = (hitY - paddleY) / paddleHeight;
    const normalizedY = (relativeY * 2) - 1;
    return normalizedY * Math.PI / 3;
  }

  function handleScore() {
    const winningThreshold = WINNING_SCORE + game.bonusPoints;

    if (game.betweenPointsTimeout) {
      clearTimeout(game.betweenPointsTimeout);
      game.betweenPointsTimeout = null;
    }

    // Play random score sound
    playRandomScoreSound();

    if (checkForSpecialMove()) {
      queueCommentary("OH MY GOODNESS! WHAT AN INCREDIBLE SHOT!", true, true);
    }
    else if ((game.leftPaddle.score === winningThreshold - 1 || 
             game.rightPaddle.score === winningThreshold - 1) && !game.matchPoint) {
      game.matchPoint = true;
      const leader = game.leftPaddle.score > game.rightPaddle.score ? game.leftPlayer : game.rightPlayer;
      queueCommentary(`THIS IS IT! CHAMPIONSHIP POINT FOR ${leader}!`, true, true);
    }
    else {
      queueCommentary(`${game.lastScorer} SCORES! ${getRandomCommentary()}`, true);
    }

    if (game.leftPaddle.score >= winningThreshold || game.rightPaddle.score >= winningThreshold) {
      endGame();
      return;
    }

    if (Math.random() < 0.3) {
      game.betweenPointsTimeout = setTimeout(() => {
        queueCommentary(getRandomCommentary());
      }, 1500);
    }

    resetBall();
  }

  function getRandomCommentary() {
    return commentaryPhrases[Math.floor(Math.random() * commentaryPhrases.length)];
  }

  function checkForSpecialMove() {
    const speedThreshold = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED * 1.5 : MAX_BALL_SPEED * 0.8;
    const now = Date.now();
    
    if (game.ball.speed >= speedThreshold && now - game.lastSpecialMoveTime > 5000) {
      game.lastSpecialMoveTime = now;
      return true;
    }
    return false;
  }

  // Game management functions
  function showTwoPlayerPrompt() {
    document.getElementById('twoPlayerPrompt').style.display = 'flex';
    document.getElementById('backButton').style.display = 'flex';
    document.getElementById('whatsNewButton').style.display = 'none';
    document.getElementById('leftPlayerName').focus();
    playSelectSound();
  }

  function cancelTwoPlayerPrompt() {
    document.getElementById('twoPlayerPrompt').style.display = 'none';
    document.getElementById('backButton').style.display = 'none';
    document.getElementById('whatsNewButton').style.display = 'block';
    playSelectSound();
  }

  function submitTwoPlayerNames() {
    const leftName = document.getElementById('leftPlayerName').value.trim() || "PLAYER 1";
    const rightName = document.getElementById('rightPlayerName').value.trim() || "PLAYER 2";
    const stage = document.getElementById('selectedStage').value;
    
    game.leftPlayer = leftName.toUpperCase();
    game.rightPlayer = rightName.toUpperCase();
    game.tournamentStage = stage;
    game.isLocalMultiplayer = true;
    game.isFourPlayer = false;
    game.isPracticeMode = false;
    game.isEndlessMode = false;
    game.gameMode = '2player';
    
    document.getElementById('twoPlayerPrompt').style.display = 'none';
    document.getElementById('backButton').style.display = 'none';
    document.getElementById('whatsNewButton').style.display = 'none';
    
    // Enter fullscreen before starting game
    if (!document.fullscreenElement) {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.webkitRequestFullscreen) {
        document.documentElement.webkitRequestFullscreen();
      }
    }
    
    // Start game after a brief delay
    setTimeout(() => {
      // Exit fullscreen right before game starts
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      startGame();
    }, 500);
    
    playSelectSound();
  }

  function showSinglePlayerPrompt() {
    document.getElementById('singlePlayerPrompt').style.display = 'flex';
    document.getElementById('backButton').style.display = 'flex';
    document.getElementById('whatsNewButton').style.display = 'none';
    document.getElementById('playerName').focus();
    playSelectSound();
  }

  function cancelSinglePlayerPrompt() {
    document.getElementById('singlePlayerPrompt').style.display = 'none';
    document.getElementById('backButton').style.display = 'none';
    document.getElementById('whatsNewButton').style.display = 'block';
    playSelectSound();
  }

  function submitSinglePlayerName() {
    const playerName = document.getElementById('playerName').value.trim() || "PLAYER";
    const difficulty = document.getElementById('selectedDifficulty').value;
    
    game.leftPlayer = playerName.toUpperCase();
    game.rightPlayer = "BOT";
    game.aiDifficulty = difficulty;
    game.isLocalMultiplayer = false;
    game.isFourPlayer = false;
    game.isPracticeMode = false;
    game.isEndlessMode = false;
    game.gameMode = '1player';
    
    document.getElementById('singlePlayerPrompt').style.display = 'none';
    document.getElementById('backButton').style.display = 'none';
    document.getElementById('whatsNewButton').style.display = 'none';
    startGame();
    playSelectSound();
  }

  function showFourPlayerPrompt() {
    document.getElementById('fourPlayerPrompt').style.display = 'flex';
    document.getElementById('backButton').style.display = 'flex';
    document.getElementById('whatsNewButton').style.display = 'none';
    document.getElementById('leftTeamName').focus();
    playSelectSound();
  }

    function cancelFourPlayerPrompt() {
      document.getElementById('fourPlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'block';
      playSelectSound();
    }

    function submitFourPlayerNames() {
      const leftName = document.getElementById('leftTeamName').value.trim() || "TEAM ONE";
      const rightName = document.getElementById('rightTeamName').value.trim() || "TEAM TWO";
      
      game.leftPlayer = leftName.toUpperCase();
      game.rightPlayer = rightName.toUpperCase();
      game.isLocalMultiplayer = true;
      game.isFourPlayer = true;
      game.isPracticeMode = false;
      game.isEndlessMode = false;
      game.gameMode = '4player';
      
      document.getElementById('fourPlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'none';
      const mobileControls = document.getElementById('mobileControls');
      if (mobileControls) mobileControls.style.display = 'none';
      startGame();
      playSelectSound();
    }

    function showEndlessPrompt() {
      document.getElementById('endlessPrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('whatsNewButton').style.display = 'none';
      document.getElementById('endlessPlayerName').focus();
      playSelectSound();
    }

    function cancelEndlessPrompt() {
      document.getElementById('endlessPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'block';
      playSelectSound();
    }

    function submitEndlessName() {
      const playerName = document.getElementById('endlessPlayerName').value.trim() || "PLAYER";
      const difficulty = document.getElementById('endlessDifficulty').value;
      const showScore = document.getElementById('showScoreToggle').checked;
      const enableCommentary = document.getElementById('commentaryToggle').checked;
      const opponentIsBot = !document.getElementById('opponentToggle').checked;
      
      game.leftPlayer = playerName.toUpperCase();
      game.rightPlayer = opponentIsBot ? "BOT" : "PLAYER 2";
      game.aiDifficulty = difficulty;
      game.isLocalMultiplayer = !opponentIsBot;
      game.isFourPlayer = false;
      game.isPracticeMode = false;
      game.isEndlessMode = true;
      game.showScore = showScore;
      game.enableCommentary = enableCommentary;
      game.opponentIsBot = opponentIsBot;
      game.gameMode = opponentIsBot ? 'endless1p' : 'endless2p';
      
      document.getElementById('endlessPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'none';
      startGame();
      playSelectSound();
    }

    function showPracticePrompt() {
      document.getElementById('practiceModePrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('whatsNewButton').style.display = 'none';
      playSelectSound();
    }

    function cancelPracticePrompt() {
      document.getElementById('practiceModePrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'block';
      playSelectSound();
    }

    function startPowerShotPractice() {
      game.leftPlayer = "PLAYER";
      game.rightPlayer = "BOT";
      game.aiDifficulty = "easy";
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = true;
      game.practiceType = "powershot";
      game.isEndlessMode = false;
      game.practiceWins = 0;
      game.gameMode = 'practice';
      
      document.getElementById('practiceModePrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'none';
      
      showPracticeInstructions(
        "LEARN POWER SHOT",
        "Press E when your power bar is full to unleash a powerful shot! The power bar fills automatically over time. Try hitting the ball with a power shot 10 times to complete this lesson."
      );
      playSelectSound();
    }

    function startRespondingPractice() {
      game.leftPlayer = "PLAYER";
      game.rightPlayer = "BOT";
      game.aiDifficulty = "medium";
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = true;
      game.practiceType = "responding";
      game.isEndlessMode = false;
      game.practiceWins = 0;
      game.gameMode = 'practice';
      
      document.getElementById('practiceModePrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'none';
      
      showPracticeInstructions(
        "LEARN RESPONDING",
        "The bot will hit shots at you. Try to return them! The bot will occasionally use power shots. Watch the ball carefully and position your paddle to hit it back. Successfully return 10 shots to complete this lesson."
      );
      playSelectSound();
    }

    function showPracticeInstructions(title, text) {
      const practiceTitle = document.getElementById('practiceTitle');
      const practiceText = document.getElementById('practiceText');
      if (practiceTitle) practiceTitle.textContent = title;
      if (practiceText) practiceText.textContent = text;
      document.getElementById('practiceInstructions').style.display = 'block';
    }

    function hidePracticeInstructions() {
      document.getElementById('practiceInstructions').style.display = 'none';
      startGame();
      playSelectSound();
    }

    function createConfetti(start = false) {
      playConfettiSound();
      
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
      const container = document.getElementById('gameContainer');
      
      // Clear old confetti
      game.confettiElements.forEach(el => el.remove());
      game.confettiElements = [];
      
      // Create new confetti
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = start ? `${Math.random() * 100}%` : '-10px';
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        
        container.appendChild(confetti);
        game.confettiElements.push(confetti);
        
        // Animate confetti
        const duration = Math.random() * 3000 + 2000;
        const delay = Math.random() * 1000;
        
        confetti.animate([
          { 
            transform: `translate(${Math.random() * 200 - 100}px, ${window.innerHeight + 10}px) rotate(${Math.random() * 360}deg)`,
            opacity: 1 
          },
          { 
            transform: `translate(${Math.random() * 200 - 100}px, ${window.innerHeight + 10}px) rotate(${Math.random() * 360}deg)`,
            opacity: 0 
          }
        ], {
          duration: duration,
          delay: delay,
          easing: 'cubic-bezier(0.1, 0.8, 0.9, 1)'
        });
        
        // Remove after animation
        setTimeout(() => {
          confetti.remove();
          game.confettiElements = game.confettiElements.filter(c => c !== confetti);
        }, duration + delay);
      }
    }

    function startGame() {
      game.isPaused = false;
      game.gameActive = false; // Game not active until countdown finishes
      game.leftPaddle.score = 0;
      game.rightPaddle.score = 0;
      game.remainingTime = HALF_TIME;
      game.currentHalf = 1;
      game.extraTime = 0;
      game.matchPoint = false;
      game.bonusPoints = 0;
      game.deuceActive = false;
      game.commentaryQueue = [];
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.last10Seconds = false;
      game.countdownNumbers = [];
      game.teamLeftCharged = false;
      game.teamRightCharged = false;
      game.particles = [];
      game.lastFrameTime = 0;
      game.practiceWins = 0;
      game.milliseconds = 0; // Reset milliseconds
      game.lastTimerUpdate = Date.now(); // Initialize timer
      
      // Reset charge bars
      game.leftCharge = 0;
      game.rightCharge = 0;
      game.leftCharged = false;
      game.rightCharged = false;
      const leftChargeElement = document.getElementById('leftCharge');
      const rightChargeElement = document.getElementById('rightCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (leftChargeElement) leftChargeElement.style.width = '0';
      if (rightChargeElement) rightChargeElement.style.width = '0';
      if (leftChargeElement) leftChargeElement.classList.remove('active');
      if (rightChargeElement) rightChargeElement.classList.remove('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
      if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
      
      // Start charging
      startLeftCharge();
      startRightCharge();
      
      // Show game elements
      if (!game.isPracticeMode && !game.isEndlessMode) {
        document.getElementById('leftScore').style.display = "block";
        document.getElementById('rightScore').style.display = "block";
        document.getElementById('timer').style.display = "block";
        document.getElementById('bonusPoints').style.display = "block";
        document.getElementById('matchInfo').style.display = "block";
      } else if (game.isEndlessMode && game.showScore) {
        document.getElementById('leftScore').style.display = "block";
        document.getElementById('rightScore').style.display = "block";
        document.getElementById('timer').style.display = "none";
        document.getElementById('bonusPoints').style.display = "none";
        document.getElementById('matchInfo').style.display = "none";
      } else if (game.isPracticeMode) {
        document.getElementById('leftScore').style.display = "block";
        document.getElementById('rightScore').style.display = "none";
        document.getElementById('timer').style.display = "none";
        document.getElementById('bonusPoints').style.display = "none";
        document.getElementById('matchInfo').style.display = "none";
      } else {
        document.getElementById('leftScore').style.display = "none";
        document.getElementById('rightScore').style.display = "none";
        document.getElementById('timer').style.display = "none";
        document.getElementById('bonusPoints').style.display = "none";
        document.getElementById('matchInfo').style.display = "none";
      }
      
      // Hide menu screens
      document.getElementById('titleScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('pauseScreen').style.display = "none";
      document.getElementById('gameOverScreen').style.display = "none";
      document.getElementById('leaderboardScreen').style.display = "none";
      
      document.getElementById('leftScore').textContent = "0";
      document.getElementById('rightScore').textContent = "0";
      
      if (!game.isPracticeMode && !game.isEndlessMode) {
        document.getElementById('timer').textContent = "1:30.000";
        document.getElementById('bonusPoints').textContent = "";
        document.getElementById('matchInfo').textContent = "1st Half | Extra Time: +0s";
      }
      
      resetBall();
      resetPaddles();
      
      // Update game info
      if (!game.isPracticeMode && !game.isEndlessMode) {
        document.getElementById('matchInfo').textContent = `${game.currentHalf === 1 ? '1st' : '2nd'} Half | ${game.tournamentStage} | Extra Time: +${game.extraTime}s`;
      }
      
      // Show commentary
      if (!game.isPracticeMode) {
        const commentaryElement = document.getElementById('commentary');
        if (commentaryElement) commentaryElement.style.display = "block";
        
        if (game.isEndlessMode) {
          if (game.enableCommentary) {
            queueCommentary("WELCOME TO ENDLESS MODE! HOW LONG CAN YOU LAST?", true);
          }
        } else {
          queueCommentary(`WELCOME TO THE ${game.tournamentStage}! ${game.leftPlayer} vs ${game.rightPlayer}!`, true);
        }
      } else {
        const commentaryElement = document.getElementById('commentary');
        if (commentaryElement) commentaryElement.style.display = "block";
        queueCommentary("PRACTICE MODE - TRY TO HIT 10 POWER SHOTS!", true);
      }
      
      // Show control buttons
      document.getElementById('muteButton').style.display = "flex";
      document.getElementById('pauseButton').style.display = "flex";
      document.getElementById('fullscreenButton').style.display = "flex";
      document.getElementById('musicMuteButton').style.display = "flex";
      document.getElementById('backButton').style.display = "flex";
      
      // Show mobile controls if on mobile
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        const mobileControls = document.getElementById('mobileControls');
        if (mobileControls) mobileControls.style.display = 'flex';
      }
      
      // Show D-Pad controls if enabled
      if (game.dpadEnabled) {
        document.getElementById('dpadControls').style.display = 'block';
        document.getElementById('dpadControlsRight').style.display = 'block';
      }
      
      // Start music
      game.musicStarted = true;
      if (game.soundEnabled && !game.isMusicMuted) {
        playRandomStartMusic();
      }
      
      // Start game loop
      game.gameStarted = true;
      game.lastFrameTime = performance.now();
      game.startTime = Date.now();
      
      // Start timer if not practice or endless mode
      if (!game.isPracticeMode && !game.isEndlessMode) {
        startTimer();
      }
      
      // Start countdown - ball won't move until countdown finishes
      startCountdown();
      
      // Start game loop
      requestAnimationFrame(gameLoop);
    }

    function toggleMute() {
      game.isMuted = !game.isMuted;
      const muteButton = document.getElementById('muteButton');
      if (muteButton) {
        muteButton.textContent = game.isMuted ? "üîá" : "üîä";
      }
      playSelectSound();
    }

    function toggleMusicMute() {
      game.isMusicMuted = !game.isMusicMuted;
      const musicMuteButton = document.getElementById('musicMuteButton');
      if (musicMuteButton) {
        musicMuteButton.textContent = game.isMusicMuted ? "üîá" : "üéµ";
      }
      
      if (game.isMusicMuted) {
        backgroundMusic.pause();
      } else if (game.soundEnabled && game.musicStarted) {
        playRandomGameMusic();
      }
      playSelectSound();
    }

    function togglePause() {
      if (!game.gameStarted || game.halftimeActive || game.countdownActive) return;
      
      game.isPaused = !game.isPaused;
      const pauseButton = document.getElementById('pauseButton');
      
      if (pauseButton) {
        pauseButton.textContent = game.isPaused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
      }
      
      if (game.isPaused) {
        // Store current game state
        game.pausedBallState = { ...game.ball };
        game.pausedPaddleState = {
          leftPaddle: { ...game.leftPaddle },
          rightPaddle: { ...game.rightPaddle }
        };
        
        // Stop timer
        if (game.timerInterval) {
          clearInterval(game.timerInterval);
          game.timerInterval = null;
        }
        
        // Show pause screen
        document.getElementById('pauseScreen').style.display = 'flex';
        
        // Stop music
        backgroundMusic.pause();
      } else {
        // Restore game state
        if (game.pausedBallState) {
          Object.assign(game.ball, game.pausedBallState);
        }
        if (game.pausedPaddleState) {
          Object.assign(game.leftPaddle, game.pausedPaddleState.leftPaddle);
          Object.assign(game.rightPaddle, game.pausedPaddleState.rightPaddle);
        }
        
        // Resume timer if needed
        if (!game.isPracticeMode && !game.isEndlessMode && !game.timerInterval) {
          startTimer();
        }
        
        // Hide pause screen
        document.getElementById('pauseScreen').style.display = 'none';
        
        // Resume music
        if (game.soundEnabled && !game.isMusicMuted && game.musicStarted) {
          playRandomGameMusic();
        }
      }
      playSelectSound();
    }

    function returnToMenu() {
      // Stop all intervals
      if (game.timerInterval) {
        clearInterval(game.timerInterval);
        game.timerInterval = null;
      }
      
      if (game.countdownInterval) {
        clearInterval(game.countdownInterval);
        game.countdownInterval = null;
      }
      
      if (game.halftimeInterval) {
        clearInterval(game.halftimeInterval);
        game.halftimeInterval = null;
      }
      
      if (game.leftChargeInterval) {
        clearInterval(game.leftChargeInterval);
        game.leftChargeInterval = null;
      }
      
      if (game.rightChargeInterval) {
        clearInterval(game.rightChargeInterval);
        game.rightChargeInterval = null;
      }
      
      // Reset game state
      game.gameStarted = false;
      game.gameActive = false;
      game.isPaused = false;
      game.halftimeActive = false;
      game.countdownActive = false;
      game.isPracticeMode = false;
      game.isEndlessMode = false;
      
      // Stop music and commentary
      backgroundMusic.pause();
      game.musicStarted = false;
      stopCommentary();
      
      // Hide game elements
      document.getElementById('leftScore').style.display = 'none';
      document.getElementById('rightScore').style.display = 'none';
      document.getElementById('timer').style.display = 'none';
      document.getElementById('bonusPoints').style.display = 'none';
      document.getElementById('matchInfo').style.display = 'none';
      document.getElementById('commentary').style.display = 'none';
      document.getElementById('pauseScreen').style.display = 'none';
      document.getElementById('endScreen').style.display = 'none';
      document.getElementById('gameOverScreen').style.display = 'none';
      document.getElementById('halftimeScreen').style.display = 'none';
      
      // Hide control buttons
      document.getElementById('muteButton').style.display = 'none';
      document.getElementById('pauseButton').style.display = 'none';
      document.getElementById('fullscreenButton').style.display = 'none';
      document.getElementById('musicMuteButton').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('whatsNewButton').style.display = 'block';
      
      // Hide mobile controls
      document.getElementById('mobileControls').style.display = 'none';
      document.getElementById('dpadControls').style.display = 'none';
      document.getElementById('dpadControlsRight').style.display = 'none';
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Show title screen
      document.getElementById('titleScreen').style.display = 'flex';
      
      playSelectSound();
    }

    function startCountdown() {
  game.countdownActive = true;
  game.gameActive = false; // Game not active during countdown
  const countdownElement = document.getElementById('countdown');
  const goTextElement = document.getElementById('goText');
  
  if (countdownElement) {
    countdownElement.style.display = 'flex';
    countdownElement.textContent = '3';
  }
  
  let count = 3;
  game.countdownInterval = setInterval(() => {
    if (countdownElement) {
      if (count > 1) {
        countdownElement.textContent = count - 1;
        playSelectSound();
      } else if (count === 1) {
        countdownElement.style.display = 'none';
        if (goTextElement) {
          goTextElement.style.display = 'flex';
          playSelectSound();
        }
      } else {
        if (goTextElement) {
          goTextElement.style.display = 'none';
        }
        clearInterval(game.countdownInterval);
        game.countdownActive = false;
        game.gameActive = true; // Game is now active!
        
        // FIX: Start the ball moving after countdown
        game.ball.dx = Math.random() > 0.5 ? game.ball.speed * 0.6 : -game.ball.speed * 0.6;
        game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed * 0.6;
        
        // Start the game after countdown
        if (!game.isPaused) {
          game.gameStarted = true;
        }
      }
    }
    count--;
  }, 1000);
}

    function startTimer() {
      if (game.timerInterval) {
        clearInterval(game.timerInterval);
      }
      
      game.lastTimerUpdate = Date.now();
      game.milliseconds = 0;
      
      game.timerInterval = setInterval(() => {
        if (!game.isPaused && !game.halftimeActive && game.gameActive) {
          const now = Date.now();
          const delta = now - game.lastTimerUpdate;
          game.lastTimerUpdate = now;
          
          // Update milliseconds
          game.milliseconds -= delta;
          
          // When milliseconds go below 0, subtract seconds
          while (game.milliseconds <= 0 && game.remainingTime > 0) {
            game.milliseconds += 1000;
            game.remainingTime--;
          }
          
          // Update timer display with milliseconds
          const minutes = Math.floor(game.remainingTime / 60);
          const seconds = game.remainingTime % 60;
          const ms = Math.max(0, Math.floor(game.milliseconds / 10));
          
          document.getElementById('timer').textContent = 
            `${minutes}:${seconds < 10 ? '0' : ''}${seconds}.${ms < 10 ? '0' : ''}${ms}${ms < 100 ? '0' : ''}`;
          
          // Check for last 10 seconds
          if (game.remainingTime <= 10 && !game.last10Seconds) {
            game.last10Seconds = true;
            if (!game.hasAnnounced10) {
              queueCommentary("LAST 10 SECONDS!", true, true);
              game.hasAnnounced10 = true;
            }
          }
          
          // Check for halftime
          if (game.remainingTime <= 0 && game.milliseconds <= 0) {
            if (game.currentHalf === 1) {
              startHalftime();
            } else {
              startOvertime();
            }
          }
        }
      }, 16); // Update every frame for smooth milliseconds
    }

    function startHalftime() {
      game.halftimeActive = true;
      game.gameActive = false; // Pause game during halftime
      clearInterval(game.timerInterval);
      
      const halftimeScreen = document.getElementById('halftimeScreen');
      if (halftimeScreen) {
        halftimeScreen.style.display = 'flex';
        halftimeScreen.textContent = 'HALF TIME!';
      }
      
      // Store scores for halftime display
      const leftScore = game.leftPaddle.score;
      const rightScore = game.rightPaddle.score;
      
      // Stop ball movement
      const ballDx = game.ball.dx;
      const ballDy = game.ball.dy;
      game.ball.dx = 0;
      game.ball.dy = 0;
      
      // Halftime commentary
      queueCommentary("WHAT A HALF THAT WAS!", true, true);
      
      game.halftimeInterval = setTimeout(() => {
        game.halftimeActive = false;
        game.currentHalf = 2;
        game.remainingTime = HALF_TIME;
        game.milliseconds = 0;
        game.hasAnnounced30 = false;
        game.hasAnnounced10 = false;
        game.last10Seconds = false;
        
        // Update match info
        document.getElementById('matchInfo').textContent = `2nd Half | ${game.tournamentStage} | Extra Time: +${game.extraTime}s`;
        
        // Reset ball and paddles
        resetBall();
        resetPaddles();
        
        // Hide halftime screen
        if (halftimeScreen) {
          halftimeScreen.style.display = 'none';
        }
        
        // Start second half countdown
        startCountdown();
        
        // Start timer again after countdown
        setTimeout(() => {
          startTimer();
        }, 4000);
        
        // Commentary for second half
        queueCommentary(`SECOND HALF! ${game.leftPlayer} ${leftScore} - ${rightScore} ${game.rightPlayer}`, true);
      }, HALF_TIME_BREAK * 1000);
    }

    function startOvertime() {
      game.extraTime += OVERTIME_TIME;
      game.remainingTime = OVERTIME_TIME;
      game.milliseconds = 0;
      playETSound();
      
      queueCommentary("EXTRA TIME!", true, true);
      
      // Update match info
      document.getElementById('matchInfo').textContent = `Extra Time | ${game.tournamentStage} | +${game.extraTime}s`;
      
      // Reset ball and paddles
      resetBall();
      resetPaddles();
      
      // Start countdown for overtime
      startCountdown();
      
      // Start timer after countdown
      setTimeout(() => {
        startTimer();
      }, 4000);
    }

    function queueCommentary(text, urgent = false, useTTS = false) {
      // Skip commentary in practice mode or if disabled in endless mode
      if (game.isPracticeMode || (game.isEndlessMode && !game.enableCommentary)) {
        return;
      }
      
      // IMPROVEMENT #4: Clear previous commentary
      if (urgent) {
        game.commentaryQueue = []; // Clear all previous commentary
        stopCommentary(); // Stop any ongoing speech
      }
      
      if (urgent) {
        game.commentaryQueue.unshift(text);
      } else {
        game.commentaryQueue.push(text);
      }
      
      if (!game.isSpeaking) {
        speakCommentary();
      }
    }

    function stopCommentary() {
      // IMPROVEMENT #4: Stop any ongoing speech
      if (game.currentUtterance) {
        speechSynthesis.cancel();
        game.currentUtterance = null;
      }
      game.isSpeaking = false;
      game.commentaryQueue = [];
      
      // Fade out commentary display
      const commentaryElement = document.getElementById('commentary');
      if (commentaryElement) {
        commentaryElement.style.opacity = '0';
      }
    }

    function speakCommentary() {
      if (game.commentaryQueue.length === 0 || game.isSpeaking) {
        game.isSpeaking = false;
        return;
      }
      
      game.isSpeaking = true;
      const text = game.commentaryQueue.shift();
      const commentaryElement = document.getElementById('commentary');
      
      if (commentaryElement) {
        commentaryElement.textContent = text;
        commentaryElement.style.opacity = '1';
        
        // Clear any existing timeout
        if (game.currentUtterance) {
          speechSynthesis.cancel();
        }
        
        // Use text-to-speech if available and enabled
        if ('speechSynthesis' in window && game.soundEnabled && !game.isMuted) {
          game.currentUtterance = new SpeechSynthesisUtterance(text);
          game.currentUtterance.rate = 1.2;
          game.currentUtterance.pitch = 1.1;
          game.currentUtterance.volume = 0.7;
          speechSynthesis.speak(game.currentUtterance);
          
          game.currentUtterance.onend = function() {
            setTimeout(() => {
              commentaryElement.style.opacity = '0';
              setTimeout(() => {
                game.isSpeaking = false;
                speakCommentary();
              }, 500);
            }, 2000);
          };
          
          game.currentUtterance.onerror = function() {
            game.isSpeaking = false;
            speakCommentary();
          };
        } else {
          // Fallback to just displaying text
          setTimeout(() => {
            commentaryElement.style.opacity = '0';
            setTimeout(() => {
              game.isSpeaking = false;
              speakCommentary();
            }, 500);
          }, 3000);
        }
      }
    }

    function endGame() {
      // Stop all intervals
      if (game.timerInterval) {
        clearInterval(game.timerInterval);
        game.timerInterval = null;
      }
      
      if (game.leftChargeInterval) {
        clearInterval(game.leftChargeInterval);
        game.leftChargeInterval = null;
      }
      
      if (game.rightChargeInterval) {
        clearInterval(game.rightChargeInterval);
        game.rightChargeInterval = null;
      }
      
      // Stop game loop and commentary
      game.gameStarted = false;
      game.gameActive = false;
      
      // Determine winner
      const winningThreshold = WINNING_SCORE + game.bonusPoints;
      const winner = game.leftPaddle.score >= winningThreshold ? game.leftPlayer : game.rightPlayer;
      const loser = game.leftPaddle.score >= winningThreshold ? game.rightPlayer : game.leftPlayer;
      const winnerScore = game.leftPaddle.score >= winningThreshold ? game.leftPaddle.score : game.rightPaddle.score;
      const loserScore = game.leftPaddle.score >= winningThreshold ? game.rightPaddle.score : game.leftPaddle.score;
      
      // Play game over sound
      playGameOverSound();
      
      // Stop music
      backgroundMusic.pause();
      
      // Create confetti for winner
      createConfetti();
      
      // IMPROVEMENT #3: Special commentary for tournament winner
      let victoryMessage;
      if (game.tournamentStage === "Finals") {
        victoryMessage = `${winner} HAS WON THE TOURNAMENT!`;
      } else {
        victoryMessage = `${winner} HAS WON THE GAME!`;
      }
      
      // Queue final commentary
      stopCommentary(); // Stop any ongoing commentary
      queueCommentary(victoryMessage, true, true);
      
      // Save to leaderboards
      if (!game.isPracticeMode && !game.isEndlessMode) {
        const gameData = {
          player1: game.leftPlayer,
          player2: game.rightPlayer,
          score1: game.leftPaddle.score,
          score2: game.rightPaddle.score,
          stage: game.tournamentStage,
          timestamp: Date.now()
        };
        
        // Save to recent plays
        saveToLeaderboard('recent', gameData);
        
        // Save to best wins if player won
        if (game.leftPlayer === winner) {
          saveToLeaderboard('best', gameData);
        }
        
        // Save to bot champions if playing against bot
        if (game.rightPlayer === "BOT" && game.leftPlayer === winner) {
          gameData.difficulty = game.aiDifficulty;
          saveToLeaderboard('bot', gameData);
        }
      }
      
      // Show end screen
      const endScreen = document.getElementById('endScreen');
      const endMessage = document.getElementById('endMessage');
      
      if (endScreen && endMessage) {
        if (game.isPracticeMode) {
          endMessage.textContent = `PRACTICE COMPLETE!`;
        } else if (game.isEndlessMode) {
          endMessage.textContent = `ENDLESS MODE: ${winnerScore}-${loserScore}`;
        } else {
          endMessage.textContent = `${winner} WINS ${winnerScore}-${loserScore}!`;
        }
        endScreen.style.display = 'flex';
      }
    }

    // Initialize the game when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>


